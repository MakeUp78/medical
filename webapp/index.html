<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Facial Analysis Application v2.0 - Web Edition</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="static/css/main.css?v=1.2">
    <link rel="stylesheet" href="static/css/components.css">
    <link rel="stylesheet" href="static/css/tables.css">
</head>

<body>
    <!-- Container principale identico alla app desktop -->
    <div class="main-container">
        <!-- SIDEBAR SINISTRA - Controlli identici all'app desktop -->
        <div class="left-sidebar">
            <div class="scrollable-controls">

                <!-- Sezione SORGENTE -->
                <div class="section" data-expanded="false">
                    <div class="section-header" onclick="toggleSection(this)">
                        <button class="toggle-btn">üéØ SORGENTE</button>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        <!-- Griglia pulsanti 2x2 identica -->
                        <div class="button-grid">
                            <button class="btn btn-primary" onclick="loadImage()">üìÅ Carica Immagine</button>
                            <button class="btn btn-info" onclick="loadVideo()">üé• Carica Video</button>
                            <button class="btn btn-success" onclick="startWebcam()">üìπ Avvia Webcam</button>
                            <button class="btn btn-warning" onclick="stopWebcam()">‚èπÔ∏è Stop Webcam</button>
                        </div>

                        <!-- Info frame corrente -->
                        <div class="status-info-frame">
                            <div class="best-frame-info" id="best-frame-info">
                                Nessun frame analizzato
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sezione STATUS SISTEMA -->
                <div class="section" data-expanded="false">
                    <div class="section-header" onclick="toggleSection(this)">
                        <button class="toggle-btn">üìä STATUS SISTEMA</button>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        <!-- Dashboard badges organizzati in griglia -->
                        <div class="badges-container">
                            <div class="badge api-badge" id="api-status">
                                üåê API: connecting...
                            </div>
                            <div class="badge webcam-badge" id="webcam-badge">
                                üìπ Webcam: Disconnessa
                            </div>
                            <div class="badge landmarks-badge" id="landmarks-badge">
                                üéØ Landmarks: 0
                            </div>
                            <div class="badge quality-badge" id="quality-badge">
                                ‚≠ê Qualit√†: N/A
                            </div>
                            <div class="badge mode-badge" id="mode-badge">
                                üîß Modalit√†: Selezione
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sezione MISURAZIONI PREDEFINITE -->
                <div class="section" data-expanded="false">
                    <div class="section-header" onclick="toggleSection(this)">
                        <button class="toggle-btn">üìè MISURAZIONI PREDEFINITE</button>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        <!-- Griglia 4 colonne per compattezza -->
                        <div class="predefined-buttons">
                            <button class="btn btn-measure" onclick="measureFaceWidth(event)">üìê Larghezza Viso</button>
                            <button class="btn btn-measure" onclick="measureFaceHeight(event)">üìè Altezza Viso</button>
                            <button class="btn btn-measure" onclick="measureEyeDistance(event)">üëÅÔ∏è Distanza
                                Occhi</button>
                            <button class="btn btn-measure" onclick="measureNoseWidth(event)">üëÉ Larghezza Naso</button>
                            <button class="btn btn-measure" onclick="measureNoseHeight(event)">üìè Altezza Naso</button>
                            <button class="btn btn-measure" onclick="measureMouthWidth(event)">üëÑ Larghezza
                                Bocca</button>
                            <button class="btn btn-measure" onclick="measureEyebrowAreas(event)">‚úÇÔ∏è Aree
                                Sopracciglia</button>

                            <!-- NUOVE FUNZIONI AGGIUNTE PER PARIT√Ä CON APP DESKTOP -->
                            <button class="btn btn-measure" onclick="measureEyeAreas(event)">üëÅÔ∏è Aree Occhi</button>
                            <button class="btn btn-measure" onclick="measureCheekWidth(event)">üòä Larghezza
                                Guance</button>
                            <button class="btn btn-measure" onclick="measureForeheadWidth(event)">ü§î Larghezza
                                Fronte</button>
                            <button class="btn btn-measure" onclick="measureChinWidth(event)">üòÆ Larghezza
                                Mento</button>
                            <button class="btn btn-measure" onclick="measureFaceProfile(event)">üë§ Profilo Viso</button>
                            <button class="btn btn-measure" onclick="measureNoseAngle(event)">üëÉ Angolo Naso</button>
                            <button class="btn btn-measure" onclick="measureMouthAngle(event)">üëÑ Angolo Bocca</button>
                            <button class="btn btn-measure" onclick="measureFaceProportions(event)">üìè
                                Proporzioni</button>
                            <button class="btn btn-measure" onclick="measureKeyDistances(event)">üîç Distanze
                                Chiave</button>
                            <button class="btn btn-measure" onclick="measureFacialSymmetry(event)">‚öñÔ∏è Simmetria</button>
                        </div>
                    </div>
                </div>

                <!-- Sezione RILEVAMENTI -->
                <div class="section" data-expanded="false">
                    <div class="section-header" onclick="toggleSection(this)">
                        <button class="toggle-btn">üîç RILEVAMENTI</button>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        <!-- Griglia 2x2 per pulsanti rilevamenti -->
                        <div class="detection-grid">
                            <button class="btn btn-detection" id="axis-btn" onclick="toggleAxis()">üìè ASSE</button>
                            <button class="btn btn-detection" id="landmarks-btn" onclick="toggleLandmarks()">üéØ
                                LANDMARKS</button>
                            <button class="btn btn-detection" id="green-dots-btn" onclick="toggleGreenDots()">üü¢ GREEN
                                DOTS</button>
                            <button class="btn btn-detection" id="measure-btn" onclick="toggleMeasureMode()">üìê
                                MISURA</button>
                        </div>
                    </div>
                </div>

                <!-- Sezione SISTEMA SCORING (NASCOSTA) -->
                <div class="section" data-expanded="false" style="display: none;">
                    <div class="section-header" onclick="toggleSection(this)">
                        <button class="toggle-btn">‚öñÔ∏è SISTEMA SCORING</button>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        <!-- Badge info score corrente -->
                        <div class="scoring-info" id="scoring-info">
                            Score corrente: 0.000
                        </div>

                        <!-- Sliders per i pesi -->
                        <div class="sliders-container">
                            <div class="slider-row">
                                <label>üëÉ Naso:</label>
                                <input type="range" id="nose-slider" class="slider" min="0" max="1" step="0.01"
                                    value="0.30" oninput="updateWeight('nose', this.value)">
                                <span class="value" id="nose-value">0.30</span>
                            </div>

                            <div class="slider-row">
                                <label>üíã Bocca:</label>
                                <input type="range" id="mouth-slider" class="slider" min="0" max="1" step="0.01"
                                    value="0.25" oninput="updateWeight('mouth', this.value)">
                                <span class="value" id="mouth-value">0.25</span>
                            </div>

                            <div class="slider-row">
                                <label>‚öñÔ∏è Simm.:</label>
                                <input type="range" id="symmetry-slider" class="slider" min="0" max="1" step="0.01"
                                    value="0.25" oninput="updateWeight('symmetry', this.value)">
                                <span class="value" id="symmetry-value">0.25</span>
                            </div>

                            <div class="slider-row">
                                <label>üëÅÔ∏è Occhi:</label>
                                <input type="range" id="eye-slider" class="slider" min="0" max="1" step="0.01"
                                    value="0.20" oninput="updateWeight('eye', this.value)">
                                <span class="value" id="eye-value">0.20</span>
                            </div>
                        </div>

                        <!-- Pulsanti preset -->
                        <div class="preset-buttons">
                            <button class="btn btn-preset" onclick="resetWeights()">üîÑ Reset</button>
                            <button class="btn btn-preset" onclick="presetNoseFocus()">üëÉ Focus Naso</button>
                            <button class="btn btn-preset" onclick="presetLessSymmetry()">‚öñÔ∏è Meno Simmetria</button>
                        </div>
                    </div>
                </div>

                <!-- Sezione CORREZIONE SOPRACCIGLIA -->
                <div class="section" data-expanded="false">
                    <div class="section-header" onclick="toggleSection(this)">
                        <button class="toggle-btn">‚úÇÔ∏è CORREZIONE SOPRACCIGLIA</button>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        <div class="eyebrow-info">
                            üí° Ritaglio sopracciglia + overlay
                        </div>

                        <div class="eyebrow-buttons">
                            <button class="btn btn-eyebrow" onclick="showLeftEyebrow()">‚úÇÔ∏è Sopracciglio
                                Sinistro</button>
                            <button class="btn btn-eyebrow" onclick="showRightEyebrow()">‚úÇÔ∏è Sopracciglio Destro</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- CANVAS CENTRALE identico al matplotlib canvas -->
        <div class="canvas-container">
            <!-- Toolbar strumenti -->
            <div class="canvas-toolbar">
                <button class="tool-btn active" data-tool="selection" onclick="setTool('selection')">üîç
                    Selezione</button>
                <button class="tool-btn" data-tool="zoom-in" onclick="setTool('zoom-in')">üîç+ Zoom In</button>
                <button class="tool-btn" data-tool="zoom-out" onclick="setTool('zoom-out')">üîç- Zoom Out</button>
                <button class="tool-btn" data-tool="pan" onclick="setTool('pan')">‚úã Pan</button>
                <button class="tool-btn" data-tool="line" onclick="setTool('line')">üìè Linea</button>
                <button class="tool-btn" data-tool="rectangle" onclick="setTool('rectangle')">‚¨õ Rettangolo</button>
                <button class="tool-btn" data-tool="circle" onclick="setTool('circle')">‚≠ï Cerchio</button>
                <button class="tool-btn" data-tool="measure" onclick="setTool('measure')">üìê Misura</button>
                <button class="tool-btn" onclick="toggleGrid()">‚öè Griglia</button>
                <button class="tool-btn" onclick="fitToWindow()">üè† Fit</button>
                <button class="tool-btn" onclick="optimizeCurrentImageDisplay()"
                    title="Ottimizza visualizzazione immagine">üéØ Ottimizza</button>
                <button class="tool-btn" onclick="toggleImageTransform()"
                    title="Abilita/Disabilita trasformazioni immagine">üîì Transform</button>
                <button class="tool-btn" onclick="clearAllMeasurementOverlays()" title="Pulisci tutte le misurazioni">üìê
                    Pulisci Mis.</button>
                <button class="tool-btn" onclick="clearCanvas()">üßπ Pulisci</button>
            </div>

            <!-- Canvas principale -->
            <div class="canvas-wrapper">
                <canvas id="main-canvas"></canvas>
            </div>

            <!-- Video webcam nascosto -->
            <video id="webcam-video" autoplay muted style="position: absolute; left: -9999px; top: -9999px;"></video>

            <!-- Info cursore -->
            <div class="cursor-info" id="cursor-info">
                Mouse: (0, 0) | Zoom: 100%
            </div>
        </div>

        <!-- SIDEBAR DESTRA identica alla colonna destra dell'app -->
        <div class="right-sidebar">

            <!-- Sezione Misurazioni -->
            <div class="section" data-expanded="false">
                <div class="section-header" onclick="toggleSection(this)">
                    <button class="toggle-btn">üìè MISURAZIONI</button>
                    <span class="icon">‚ñ∫</span>
                </div>
                <div class="section-content" style="display: none;">
                    <div class="table-container">
                        <table class="data-table" id="measurements-table">
                            <thead>
                                <tr>
                                    <th>üìè Tipo Misurazione</th>
                                    <th>üìä Valore</th>
                                    <th>üìê Unit√†</th>
                                    <th>‚úÖ Stato</th>
                                </tr>
                            </thead>
                            <tbody id="measurements-data">
                                <!-- Dati dinamici verranno inseriti qui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sezione Landmarks -->
            <div class="section" data-expanded="false">
                <div class="section-header" onclick="toggleSection(this)">
                    <button class="toggle-btn">üéØ LANDMARKS</button>
                    <span class="icon">‚ñ∫</span>
                </div>
                <div class="section-content" style="display: none;">
                    <div class="table-container">
                        <table class="data-table" id="landmarks-table">
                            <thead>
                                <tr>
                                    <th>üé®</th>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>X</th>
                                    <th>Y</th>
                                </tr>
                            </thead>
                            <tbody id="landmarks-data">
                                <!-- Dati landmarks verranno inseriti qui -->
                            </tbody>
                        </table>
                    </div>

                    <!-- üìÑ Controlli paginazione landmarks -->
                    <div class="landmarks-controls" id="landmarks-pagination" style="display: none;">
                        <button class="btn btn-mini" onclick="showLandmarksPage('prev')" id="landmarks-prev">‚óÄ
                            Prec</button>
                        <span class="landmarks-page-info" id="landmarks-page-info">Pagina 1/1</span>
                        <button class="btn btn-mini" onclick="showLandmarksPage('next')" id="landmarks-next">Succ
                            ‚ñ∂</button>
                        <button class="btn btn-mini" onclick="showAllLandmarks()"
                            title="Mostra tutti i landmarks in una nuova finestra">üìã Tutti</button>
                    </div>
                </div>
            </div>

            <!-- Sezione Debug -->
            <div class="section" data-expanded="true">
                <div class="section-header" onclick="toggleSection(this)">
                    <button class="toggle-btn">üêõ DEBUG ANALYSIS</button>
                    <span class="icon">‚ñº</span>
                </div>
                <div class="section-content debug-content">
                    <div class="table-container">
                        <table class="data-table debug-table" id="debug-table">
                            <thead>
                                <tr>
                                    <th>Frame</th>
                                    <th>Tempo</th>
                                    <th>Score</th>
                                    <th>Yaw</th>
                                    <th>Pitch</th>
                                    <th>Roll</th>
                                    <th>Stato</th>
                                </tr>
                            </thead>
                            <tbody id="debug-data">
                                <!-- Dati debug verranno inseriti qui -->
                            </tbody>
                        </table>
                    </div>
                    <div class="debug-controls">
                        <button class="btn btn-small" onclick="clearDebugLogs()" style="display: none;">Pulisci</button>
                        <button class="btn btn-small" onclick="ensureSidebarSectionsVisible()"
                            title="Ripristina visibilit√† sezioni" style="display: none;">üîß Ripristina UI</button>
                        <label class="auto-scroll-label" style="display: none;">
                            <input type="checkbox" id="auto-scroll" checked> Auto
                        </label>
                    </div>
                </div>
            </div>

            <!-- Anteprima Webcam nella colonna destra -->
            <div class="section" data-expanded="false">
                <div class="section-header" onclick="toggleSection(this)">
                    <button class="toggle-btn">üìπ ANTEPRIMA WEBCAM</button>
                    <span class="icon">‚ñ∫</span>
                </div>
                <div class="section-content webcam-preview-content" style="display: none;">
                    <canvas id="webcam-preview-canvas"></canvas>
                    <div id="webcam-preview-info">Anteprima webcam non attiva</div>
                </div>
            </div>
        </div>

    </div>
    </div>

    <!-- Finestra modale per anteprima video -->
    <div id="preview-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Anteprima Video - Analisi in corso</h3>
                <span class="close" onclick="closeVideoPreview()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Player video per anteprima in tempo reale -->
                <div id="video-player-container" style="display: none;">
                    <video id="preview-video" width="640" height="480" controls>
                        Il tuo browser non supporta il tag video.
                    </video>
                    <div class="video-controls">
                        <button id="analyze-current-frame" class="btn btn-primary">üéØ Analizza Frame Corrente</button>
                        <button id="auto-analyze" class="btn btn-success">ü§ñ Analisi Automatica</button>
                        <button id="stop-analysis" class="btn btn-danger" style="display: none;">‚èπÔ∏è Ferma</button>
                    </div>
                </div>

                <!-- Canvas per risultati analisi -->
                <canvas id="preview-canvas" width="640" height="480" style="display: none;"></canvas>

                <!-- Area info/status -->
                <div class="preview-info" id="preview-info">
                    In attesa del video...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal separato per l'analisi video automatica -->
    <div id="video-analysis-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Analisi Video Automatica</h3>
                <span class="close" onclick="closeVideoAnalysis()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="video-analysis-status">
                    <div class="analysis-progress">
                        <div class="spinner"></div>
                        <p>Analisi in corso...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status bar -->
    <div class="status-bar">
        <div class="status-text" id="status-text">Pronto</div>
        <div class="progress-container" id="progress-container" style="display: none;">
            <div class="progress-bar" id="progress-bar"></div>
            <span class="progress-text" id="progress-text">0%</span>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Patch per bug textBaseline PRIMA di Fabric.js -->
    <script>
        console.log('üîß Applicando patch preventivo per textBaseline...');

        // Patch preventivo per il CanvasRenderingContext2D
        if (typeof CanvasRenderingContext2D !== 'undefined') {
            const descriptor = Object.getOwnPropertyDescriptor(CanvasRenderingContext2D.prototype, 'textBaseline');
            if (descriptor && descriptor.set) {
                const originalSetter = descriptor.set;
                Object.defineProperty(CanvasRenderingContext2D.prototype, 'textBaseline', {
                    set: function (value) {
                        // Correggi automaticamente il valore errato PRIMA che causi errori
                        if (value === 'alphabetical') {
                            // Correzione silenziosa per evitare spam nella console
                            value = 'alphabetic';
                        }
                        return originalSetter.call(this, value);
                    },
                    get: descriptor.get,
                    enumerable: true,
                    configurable: true
                });
            }
        }

        console.log('üîß Patch preventivo applicato!');
    </script>

    <!-- Fabric.js per canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

    <script src="static/js/api-client.js?v=1.5"></script>
    <script src="static/js/face-detection.js?v=1.5"></script>
    <script src="static/js/measurements.js?v=2.0"></script>
    <script src="static/js/scoring.js?v=1.5"></script>
    <script src="static/js/canvas.js?v=2.8"></script>
    <!-- NUOVO FILE PULITO - Correzione sopracciglia -->
    <script src="static/js/eyebrow-correction.js?v=2.6"></script>
    <script src="static/js/main.js?v=6.17"></script>

    <!-- Script di test per debug -->
    <script>
        console.log('üß™ TEST SCRIPT CARICATO');

        // Test dopo il caricamento completo
        window.addEventListener('load', function () {
            console.log('üß™ PAGINA COMPLETAMENTE CARICATA');
            console.log('üß™ Stato variabili globali:', {
                currentLandmarks: typeof currentLandmarks !== 'undefined' ? currentLandmarks?.length : 'undefined',
                fabricCanvas: typeof fabricCanvas !== 'undefined' ? !!fabricCanvas : 'undefined',
                transformLandmarkCoordinate: typeof window.transformLandmarkCoordinate !== 'undefined' ? 'function available' : 'undefined',
                measureFaceWidth: typeof measureFaceWidth !== 'undefined' ? 'function available' : 'undefined'
            });

            // Test diretto della funzione di misurazione (disabilitato)
            // setTimeout(() => {
            //     console.log('üß™ TEST DIRETTO - Chiamata measureFaceWidth()');
            //     if (typeof measureFaceWidth === 'function') {
            //         try {
            //             measureFaceWidth();
            //         } catch (e) {
            //             console.error('üß™ ERRORE in measureFaceWidth:', e);
            //         }
            //     } else {
            //         console.error('üß™ measureFaceWidth NON DEFINITA');
            //     }
            // }, 2000);
        });
    </script>

    <!-- MediaPipe per face detection -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

    <!-- ========================================
         VOICE ASSISTANT INTEGRATION
         ======================================== -->

    <!-- Voice Assistant Script -->
    <script src="static/js/voice_assistant.js"></script>

    <!-- Voice Widget Container -->
    <div id="voice-widget-container"></div>

    <script>
        // Carica widget voice assistant
        fetch('templates/voice_widget.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('voice-widget-container').innerHTML = html;
            })
            .catch(err => console.warn('Voice widget non caricato:', err));
    </script>

    <!-- Integrazione Voice Feedback nelle funzioni esistenti -->
    <script>
        // Attendi che voiceAssistant sia disponibile
        if (typeof voiceAssistant !== 'undefined') {

            // Non sovrascrivere loadImage, loadVideo, startWebcam, stopWebcam
            // perch√© ora il voice assistant simula click sui pulsanti

            // Aggiungi listener per il caricamento immagine/video
            // (il feedback vocale verr√† dato quando il file √® effettivamente caricato)
            const originalHandleFileLoad = window.handleFileLoad;
            if (originalHandleFileLoad) {
                window.handleFileLoad = function (file) {
                    const result = originalHandleFileLoad(file);
                    // Feedback vocale dopo il caricamento
                    setTimeout(() => {
                        voiceAssistant.speakMessage('image_loaded');
                    }, 500);
                    return result;
                };
            }

            // SORGENTE - Avvia Webcam
            const originalStartWebcam = window.startWebcam;
            window.startWebcam = async function () {
                if (originalStartWebcam) await originalStartWebcam();
                voiceAssistant.speakMessage('webcam_started');
            };

            // SORGENTE - Stop Webcam
            const originalStopWebcam = window.stopWebcam;
            window.stopWebcam = function () {
                if (originalStopWebcam) originalStopWebcam();
                voiceAssistant.speakMessage('webcam_stopped');
            };

            // TOGGLE - Asse di Simmetria
            const originalToggleAxis = window.toggleAxis;
            window.toggleAxis = function () {
                if (originalToggleAxis) originalToggleAxis();

                const axisBtn = document.getElementById('axis-btn');
                if (axisBtn && axisBtn.classList.contains('active')) {
                    voiceAssistant.speakMessage('axis_on');
                } else {
                    voiceAssistant.speakMessage('axis_off');
                }
            };

            // TOGGLE - Landmarks
            const originalToggleLandmarks = window.toggleLandmarks;
            window.toggleLandmarks = function () {
                if (originalToggleLandmarks) originalToggleLandmarks();

                const landmarksBtn = document.getElementById('landmarks-btn');
                if (landmarksBtn && landmarksBtn.classList.contains('active')) {
                    voiceAssistant.speakMessage('landmarks_on');
                } else {
                    voiceAssistant.speakMessage('landmarks_off');
                }
            };

            // TOGGLE - Green Dots
            const originalToggleGreenDots = window.toggleGreenDots;
            window.toggleGreenDots = function () {
                if (originalToggleGreenDots) originalToggleGreenDots();

                const greenDotsBtn = document.getElementById('green-dots-btn');
                if (greenDotsBtn && greenDotsBtn.classList.contains('active')) {
                    voiceAssistant.speakMessage('green_dots_on');
                } else {
                    voiceAssistant.speakMessage('green_dots_off');
                }
            };

            // ANALISI - Volto
            const originalAnalyzeFace = window.analyzeFace;
            window.analyzeFace = async function () {
                voiceAssistant.speakMessage('analysis_start');

                if (originalAnalyzeFace) {
                    try {
                        await originalAnalyzeFace();
                        voiceAssistant.speakMessage('analysis_complete');
                    } catch (error) {
                        voiceAssistant.speakMessage('analysis_failed');
                    }
                }
            };

            // CANVAS - Pulisci
            const originalClearCanvas = window.clearCanvas;
            window.clearCanvas = function () {
                if (originalClearCanvas) originalClearCanvas();
                voiceAssistant.speak('Canvas pulito');
            };

            // MISURAZIONI - Aggiungi feedback vocale
            const measurementFunctions = [
                'measureFaceWidth', 'measureFaceHeight', 'measureEyeDistance',
                'measureNoseWidth', 'measureNoseHeight', 'measureMouthWidth'
            ];

            measurementFunctions.forEach(funcName => {
                const original = window[funcName];
                if (original) {
                    window[funcName] = function (event) {
                        voiceAssistant.speakMessage('measurement_started');
                        original(event);
                    };
                }
            });

            console.log('‚úÖ Voice Assistant integrato con successo');
        }
    </script>

    <!-- Voice Widget Control Functions (Global) -->
    <script>
        // Variabili globali per il widget
        let isVoiceWidgetMinimized = false;
        let isVoiceListening = false;
        let isVoiceMuted = false;

        function toggleVoiceWidget() {
            isVoiceWidgetMinimized = !isVoiceWidgetMinimized;
            const widget = document.getElementById('voice-assistant-widget');
            const btn = document.querySelector('.voice-minimize-btn');

            if (widget && btn) {
                if (isVoiceWidgetMinimized) {
                    widget.classList.add('minimized');
                    btn.textContent = '+';
                } else {
                    widget.classList.remove('minimized');
                    btn.textContent = '‚àí';
                }
            }
        }

        function toggleVoiceListening() {
            if (typeof voiceAssistant === 'undefined') {
                console.error('voiceAssistant non disponibile');
                return;
            }

            const btn = document.getElementById('toggle-listening-btn');
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');

            isVoiceListening = voiceAssistant.toggleListening();

            if (btn) {
                if (isVoiceListening) {
                    btn.classList.add('active');
                    if (btn.querySelector('.btn-text')) btn.querySelector('.btn-text').textContent = 'Stop Ascolto';
                    if (btn.querySelector('.btn-icon')) btn.querySelector('.btn-icon').textContent = 'üî¥';
                    if (indicator) {
                        indicator.textContent = 'üî¥';
                        indicator.classList.add('listening');
                    }
                    if (statusText) statusText.textContent = 'In ascolto...';
                } else {
                    btn.classList.remove('active');
                    if (btn.querySelector('.btn-text')) btn.querySelector('.btn-text').textContent = 'Avvia Ascolto';
                    if (btn.querySelector('.btn-icon')) btn.querySelector('.btn-icon').textContent = 'üé§';
                    if (indicator) {
                        indicator.textContent = 'üü¢';
                        indicator.classList.remove('listening');
                        indicator.classList.add('active');
                    }
                    if (statusText) statusText.textContent = 'Pronto';
                }
            }
        }

        function toggleVoiceMute() {
            if (typeof voiceAssistant === 'undefined') {
                console.error('voiceAssistant non disponibile');
                return;
            }

            const btn = document.getElementById('toggle-mute-btn');

            isVoiceMuted = voiceAssistant.toggleMute();

            if (btn) {
                if (isVoiceMuted) {
                    btn.classList.add('active');
                    if (btn.querySelector('.btn-text')) btn.querySelector('.btn-text').textContent = 'Unmute';
                    if (btn.querySelector('.btn-icon')) btn.querySelector('.btn-icon').textContent = 'üîá';
                } else {
                    btn.classList.remove('active');
                    if (btn.querySelector('.btn-text')) btn.querySelector('.btn-text').textContent = 'Muto';
                    if (btn.querySelector('.btn-icon')) btn.querySelector('.btn-icon').textContent = 'üîä';
                }
            }
        }
    </script>

</body>

</html>