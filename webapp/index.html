<!DOCTYPE html>
<html lang="it">

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Facial Analysis Application v2.0 - Web Edition</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="static/css/main.css">
    <link rel="stylesheet" href="static/css/components.css">
    <link rel="stylesheet" href="static/css/tables.css">
    <link rel="stylesheet" href="static/css/mobile-responsive.css">
</head>

<body>
    <!-- Container principale identico alla app desktop -->
    <div class="main-container">
        <!-- SIDEBAR SINISTRA - Controlli identici all'app desktop -->
        <div class="left-sidebar">
            <div class="scrollable-controls">

                <!-- Sezione UTENTE -->
                <div class="user-section">
                    <div class="user-info">
                        <div class="user-avatar">
                            <img id="user-avatar-img"
                                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e0e0e0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='40' fill='%23666'%3Eüë§%3C/text%3E%3C/svg%3E"
                                alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        </div>
                        <div class="user-details">
                            <div class="user-name" id="user-name">Caricamento...</div>
                            <div class="user-role" id="user-role">
                                <span class="role-badge operator" id="role-badge">Operatore</span>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <button class="btn-profile" onclick="window.location.href='profile.html'"
                            style="flex: 1; padding: 0.5rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                            üë§ Profilo
                        </button>
                        <button class="btn-logout" onclick="logout()" style="flex: 1; padding: 0.5rem;">Esci</button>
                    </div>
                </div>

                <!-- Sezione SORGENTE -->
                <div class="section" data-expanded="false">
                    <div class="section-header" onclick="toggleSection(this)">
                        <button class="toggle-btn">üéØ SORGENTE</button>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        <!-- Griglia pulsanti 2x2 identica -->
                        <div class="button-grid">
                            <button class="btn btn-primary" onclick="loadImage()">üìÅ Carica Immagine</button>
                            <button class="btn btn-info" onclick="loadVideo()">üé• Carica Video</button>
                            <button class="btn btn-success" onclick="startWebcam()">üìπ Avvia Webcam</button>
                            <button class="btn btn-warning" onclick="stopWebcam()">‚èπÔ∏è Stop Webcam</button>
                        </div>
                    </div>
                </div>

                <!-- Sezione ANALISI (unione di Rilevamenti + Misurazioni Predefinite) -->
                <div class="section" data-expanded="false">
                    <div class="section-header" onclick="toggleSection(this)">
                        <button class="toggle-btn">üî¨ ANALISI</button>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        <!-- Griglia unificata 2 colonne - tutti pulsanti arancioni stessa dimensione -->
                        <div class="analysis-buttons">
                            <!-- Pulsanti Rilevamenti -->
                            <button class="btn btn-analysis" id="axis-btn" onclick="toggleAxis()">üìè Asse</button>
                            <button class="btn btn-analysis" id="landmarks-btn" onclick="toggleLandmarks()">üéØ
                                Landmarks</button>
                            <button class="btn btn-analysis" id="measure-btn" onclick="toggleMeasureMode()">üìê
                                Misura</button>

                            <!-- Pulsanti Misurazioni Predefinite -->
                            <button class="btn btn-analysis" onclick="measureFaceWidth(event)">üìê Larghezza
                                Viso</button>
                            <button class="btn btn-analysis" onclick="measureFaceHeight(event)">üìè Altezza Viso</button>
                            <button class="btn btn-analysis" onclick="measureEyeDistance(event)">üëÅÔ∏è Distanza
                                Occhi</button>
                            <button class="btn btn-analysis" onclick="measureNoseWidth(event)">üëÉ Larghezza
                                Naso</button>
                            <button class="btn btn-analysis" onclick="measureNoseHeight(event)">üìè Altezza Naso</button>
                            <button class="btn btn-analysis" onclick="measureMouthWidth(event)">üëÑ Larghezza
                                Bocca</button>
                            <button class="btn btn-analysis" onclick="measureEyebrowAreas(event)">‚úÇÔ∏è Aree
                                Sopracciglia</button>
                            <button class="btn btn-analysis" onclick="measureEyeAreas(event)">üëÅÔ∏è Aree Occhi</button>
                            <button class="btn btn-analysis" onclick="measureCheekWidth(event)">üòä Larghezza
                                Guance</button>
                            <button class="btn btn-analysis" onclick="measureForeheadWidth(event)">ü§î Larghezza
                                Fronte</button>
                            <button class="btn btn-analysis" onclick="measureChinWidth(event)">üòÆ Larghezza
                                Mento</button>
                            <button class="btn btn-analysis" onclick="measureFaceProfile(event)">üë§ Profilo
                                Viso</button>
                            <button class="btn btn-analysis" onclick="measureNoseAngle(event)">üëÉ Angolo Naso</button>
                            <button class="btn btn-analysis" onclick="measureMouthAngle(event)">üëÑ Angolo Bocca</button>
                            <button class="btn btn-analysis" onclick="measureFaceProportions(event)">üìè
                                Proporzioni</button>
                            <button class="btn btn-analysis" onclick="measureKeyDistances(event)">üîç Distanze
                                Chiave</button>
                            <button class="btn btn-analysis" onclick="measureFacialSymmetry(event)">‚öñÔ∏è
                                Simmetria</button>
                            <button class="btn btn-analysis" onclick="estimateAge(event)">üéÇ Stima Et√†</button>

                            <!-- Pulsante Analisi Completa - occupa tutta la larghezza -->
                            <button class="btn btn-analysis btn-analysis-complete"
                                onclick="performCompleteAnalysis(event)">
                                üß¨ ANALISI VISAGISTICA COMPLETA
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sezione SISTEMA SCORING (NASCOSTA) -->
                <div class="section" data-expanded="false" style="display: none;">
                    <div class="section-header" onclick="toggleSection(this)">
                        <button class="toggle-btn">‚öñÔ∏è SISTEMA SCORING</button>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        <!-- Badge info score corrente -->
                        <div class="scoring-info" id="scoring-info">
                            Score corrente: 0.000
                        </div>

                        <!-- Sliders per i pesi -->
                        <div class="sliders-container">
                            <div class="slider-row">
                                <label>üëÉ Naso:</label>
                                <input type="range" id="nose-slider" class="slider" min="0" max="1" step="0.01"
                                    value="0.30" oninput="updateWeight('nose', this.value)">
                                <span class="value" id="nose-value">0.30</span>
                            </div>

                            <div class="slider-row">
                                <label>üíã Bocca:</label>
                                <input type="range" id="mouth-slider" class="slider" min="0" max="1" step="0.01"
                                    value="0.25" oninput="updateWeight('mouth', this.value)">
                                <span class="value" id="mouth-value">0.25</span>
                            </div>

                            <div class="slider-row">
                                <label>‚öñÔ∏è Simm.:</label>
                                <input type="range" id="symmetry-slider" class="slider" min="0" max="1" step="0.01"
                                    value="0.25" oninput="updateWeight('symmetry', this.value)">
                                <span class="value" id="symmetry-value">0.25</span>
                            </div>

                            <div class="slider-row">
                                <label>üëÅÔ∏è Occhi:</label>
                                <input type="range" id="eye-slider" class="slider" min="0" max="1" step="0.01"
                                    value="0.20" oninput="updateWeight('eye', this.value)">
                                <span class="value" id="eye-value">0.20</span>
                            </div>
                        </div>

                        <!-- Pulsanti preset -->
                        <div class="preset-buttons">
                            <button class="btn btn-preset" onclick="resetWeights()">üîÑ Reset</button>
                            <button class="btn btn-preset" onclick="presetNoseFocus()">üëÉ Focus Naso</button>
                            <button class="btn btn-preset" onclick="presetLessSymmetry()">‚öñÔ∏è Meno Simmetria</button>
                        </div>
                    </div>
                </div>

                <!-- Sezione CORREZIONE PROGETTAZIONE -->
                <div class="section" data-expanded="false">
                    <div class="section-header" onclick="toggleSection(this)">
                        <button class="toggle-btn">‚úÇÔ∏è CORREZIONE PROGETTAZIONE</button>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        <div class="eyebrow-info">
                            Quale sopracciglio piace di pi√π alla cliente? Quello alla tua DESTRA o alla tua SINISTRA?
                        </div>

                        <div class="eyebrow-buttons">
                            <button class="btn btn-analysis" id="green-dots-btn" onclick="toggleGreenDots()">ÔøΩ Trova
                                Differenze</button>
                            <button class="btn btn-eyebrow" onclick="show_left_eyebrow_with_voice()">‚úÇÔ∏è Preferenza
                                Destra</button>
                            <button class="btn btn-eyebrow" onclick="show_right_eyebrow_with_voice()">‚úÇÔ∏è Preferenza
                                Sinistra</button>
                        </div>
                    </div>
                </div>

                <!-- Sezione ASSISTENTE VOCALE -->
                <div class="section" data-expanded="false" id="voice-assistant-section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <button class="toggle-btn">üé§ ASSISTENTE VOCALE</button>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        <!-- Voice Assistant Content -->
                        <div id="voice-assistant-sidebar-content">
                            <!-- Status -->
                            <div class="voice-status-sidebar" id="voice-status-sidebar">
                                <div class="status-indicator-sidebar active" id="status-indicator-sidebar">üü¢</div>
                                <span id="status-text-sidebar">Pronto</span>
                            </div>

                            <!-- Controlli principali -->
                            <div class="voice-controls-sidebar">
                                <button class="btn btn-primary" id="toggle-listening-btn-sidebar"
                                    onclick="toggleVoiceListening()">
                                    <span id="listening-icon-sidebar">üé§</span>
                                    <span id="listening-text-sidebar">Avvia Ascolto</span>
                                </button>

                                <button class="btn btn-secondary" id="toggle-mute-btn-sidebar"
                                    onclick="toggleVoiceMute()">
                                    <span id="mute-icon-sidebar">üîä</span>
                                    <span id="mute-text-sidebar">Muto</span>
                                </button>
                            </div>

                            <!-- Info riconoscimento -->
                            <div class="voice-info-sidebar" id="voice-last-command-sidebar">
                                Ultimo comando: <span id="last-command-text-sidebar">Nessuno</span>
                            </div>

                            <!-- Messaggi rapidi -->
                            <div class="voice-quick-messages-sidebar" style="display:none;">
                                <div class="quick-msg-title-sidebar">Messaggi Rapidi:</div>
                                <div class="quick-msg-buttons-sidebar">
                                    <button class="btn btn-info btn-small"
                                        onclick="voiceAssistant.speakMessage('welcome')">üëã Benvenuto</button>
                                    <button class="btn btn-info btn-small"
                                        onclick="voiceAssistant.speakMessage('axis_on')">üìè Asse On</button>
                                    <button class="btn btn-info btn-small"
                                        onclick="voiceAssistant.speakMessage('landmarks_on')">üéØ Landmarks On</button>
                                </div>
                            </div>

                            <!-- Lista comandi vocali disponibili -->
                            <details class="voice-commands-help-sidebar">
                                <summary>üìã Comandi Vocali</summary>
                                <div class="commands-list-sidebar">
                                    <div class="command-item-sidebar">
                                        <strong>"Kimerika"</strong> ‚Üí Attiva ascolto comandi
                                    </div>
                                    <div class="command-item-sidebar">
                                        <strong>"Asse"</strong> ‚Üí Attiva/disattiva asse di simmetria
                                    </div>
                                    <div class="command-item-sidebar">
                                        <strong>"Landmarks"</strong> ‚Üí Attiva/disattiva punti facciali
                                    </div>
                                    <div class="command-item-sidebar">
                                        <strong>"Punti verdi"</strong> ‚Üí Rileva punti verdi sopracciglia
                                    </div>
                                    <div class="command-item-sidebar">
                                        <strong>"Avvia webcam"</strong> ‚Üí Avvia webcam
                                    </div>
                                    <div class="command-item-sidebar">
                                        <strong>"Stop webcam"</strong> ‚Üí Ferma webcam
                                    </div>
                                    <div class="command-item-sidebar">
                                        <strong>"Carica immagine"</strong> ‚Üí Apri caricamento immagine
                                    </div>
                                    <div class="command-item-sidebar">
                                        <strong>"Carica video"</strong> ‚Üí Apri caricamento video
                                    </div>
                                    <div class="command-item-sidebar">
                                        <strong>"Analizza"</strong> ‚Üí Avvia analisi facciale
                                    </div>
                                    <div class="command-item-sidebar">
                                        <strong>"Pulisci"</strong> ‚Üí Pulisci canvas
                                    </div>
                                    <div class="command-item-sidebar">
                                        <strong>"Simmetria"</strong> ‚Üí Analisi simmetria viso
                                    </div>
                                    <div class="command-item-sidebar">
                                        <strong>"Sopracciglio sinistro"</strong> ‚Üí Analizza sopracciglio sx
                                    </div>
                                    <div class="command-item-sidebar">
                                        <strong>"Sopracciglio destro"</strong> ‚Üí Analizza sopracciglio dx
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>

                <!-- Sezione IMPOSTAZIONI -->
                <div class="section" data-expanded="false" id="settings-section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <button class="toggle-btn">‚öôÔ∏è IMPOSTAZIONI</button>
                        <span class="icon">‚ñ∫</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        <!-- Info Webcam Smartphone -->
                        <div class="settings-info">
                            <h4 style="margin-top: 0; color: #333;">üì± Usa Smartphone come Webcam</h4>
                            <p style="font-size: 0.9em; color: #555; margin-bottom: 1rem;">
                                Configura il tuo smartphone come webcam professionale con la procedura guidata.
                            </p>

                            <!-- Avvio Rapido IRIUN per Utenti Esperti -->
                            <div id="quick-launch-panel" style="display: none; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5em;">‚ö°</span>
                                    <h4 style="margin: 0; font-size: 1.1em;">Avvio Rapido IRIUN</h4>
                                </div>
                                <p style="margin: 0.5rem 0; font-size: 0.9em; opacity: 0.95;">
                                    Sistema di monitoraggio automatico per utenti esperti
                                </p>
                                <button onclick="launchQuickStart()" class="btn" 
                                        style="width: 100%; font-size: 0.95em; padding: 0.7rem; background: white; color: #667eea; font-weight: bold; border: none; margin-top: 0.5rem;">
                                    üöÄ Avvia Monitoraggio Automatico
                                </button>
                                <div id="quick-launch-status" style="margin-top: 0.5rem; font-size: 0.85em; opacity: 0.9;"></div>
                            </div>

                            <!-- Wizard Configurazione IRIUN -->
                            <div id="iriun-wizard" style="margin-bottom: 1rem;">
                                <!-- Passo 1: Download e Installazione -->
                                <div class="wizard-step" id="step-1"
                                    style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6c757d;">
                                    <div
                                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <h5 style="margin: 0; color: #333;">
                                            <span id="step-1-icon">‚è∏Ô∏è</span> Passo 1: Installa IRIUN
                                        </h5>
                                        <span id="step-1-status" style="font-size: 0.8em; color: #6c757d;">In
                                            attesa</span>
                                    </div>
                                    <p style="margin: 0.5rem 0; color: #555; font-size: 0.9em;">
                                        Scarica e installa IRIUN Webcam su PC e smartphone.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                        <a href="https://iriun.com" target="_blank" class="btn btn-primary"
                                            style="font-size: 0.85em; padding: 0.4rem 0.8rem; text-decoration: none; display: inline-block;">
                                            üíª Download PC
                                        </a>
                                        <button onclick="markStepComplete(1)" class="btn btn-success"
                                            style="font-size: 0.85em; padding: 0.4rem 0.8rem;">
                                            ‚úÖ Ho installato ora
                                        </button>
                                        <button onclick="skipToStep2()" class="btn btn-info"
                                            style="font-size: 0.85em; padding: 0.4rem 0.8rem;">
                                            ‚è© Gi√† installato
                                        </button>
                                    </div>
                                    <details style="margin-top: 0.5rem; font-size: 0.85em;">
                                        <summary style="cursor: pointer; color: #667eea;">‚ÑπÔ∏è Info installazione
                                        </summary>
                                        <div style="margin-top: 0.5rem; color: #666; line-height: 1.5;">
                                            <strong>PC:</strong> Vai su iriun.com e scarica la versione per il tuo
                                            sistema operativo.<br>
                                            <strong>Smartphone:</strong> Cerca "IRIUN Webcam" su Play Store (Android) o
                                            App Store (iOS).<br>
                                            <strong>Se hai gi√† installato:</strong> Clicca "‚è© Gi√† installato" per
                                            saltare al passo successivo.
                                        </div>
                                    </details>
                                </div>

                                <!-- Passo 2: Avvio IRIUN PC -->
                                <div class="wizard-step" id="step-2"
                                    style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6c757d; opacity: 0.6;">
                                    <div
                                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <h5 style="margin: 0; color: #333;">
                                            <span id="step-2-icon">‚è∏Ô∏è</span> Passo 2: Avvia IRIUN sul PC
                                        </h5>
                                        <span id="step-2-status" style="font-size: 0.8em; color: #6c757d;">In
                                            attesa</span>
                                    </div>
                                    <p style="margin: 0.5rem 0; color: #555; font-size: 0.9em;">
                                        Apri l'applicazione IRIUN Webcam sul computer.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                        <button onclick="openIriunApp()" class="btn btn-primary"
                                            style="font-size: 0.85em; padding: 0.4rem 0.8rem;">
                                            üíª Esegui IRIUN
                                        </button>
                                        <button onclick="checkIriunRunning()" class="btn btn-info"
                                            style="font-size: 0.85em; padding: 0.4rem 0.8rem;">
                                            üîç Verifica IRIUN
                                        </button>
                                        <button onclick="markStepComplete(2)" class="btn btn-success"
                                            style="font-size: 0.85em; padding: 0.4rem 0.8rem;">
                                            ‚úÖ Avviato
                                        </button>
                                    </div>
                                    <div id="iriun-path-config" style="margin-top: 0.5rem; font-size: 0.85em; color: #666;">
                                        <details>
                                            <summary style="cursor: pointer; color: #667eea;">‚öôÔ∏è Configura percorso IRIUN</summary>
                                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border: 1px solid #dee2e6; border-radius: 4px;">
                                                <p style="margin: 0 0 0.5rem 0; font-size: 0.9em;">Inserisci il percorso dell'eseguibile IRIUN sul tuo PC:</p>
                                                <input type="text" id="iriun-path-input" 
                                                       placeholder="Es: C:\Program Files\Iriun\iriun-webcam.exe"
                                                       style="width: 100%; padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85em; margin-bottom: 0.5rem;">
                                                <button onclick="saveIriunPath()" class="btn btn-success" 
                                                        style="font-size: 0.85em; padding: 0.3rem 0.6rem; width: 100%;">
                                                    üíæ Salva Percorso
                                                </button>
                                                <p style="margin: 0.5rem 0 0 0; font-size: 0.8em; color: #856404; background: #fff3cd; padding: 0.3rem; border-radius: 3px;">
                                                    ‚ö†Ô∏è Percorso salvato per il prossimo avvio rapido
                                                </p>
                                            </div>
                                        </details>
                                    </div>
                                </div>

                                <!-- Passo 3: Connessione Smartphone -->
                                <div class="wizard-step" id="step-3"
                                    style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6c757d; opacity: 0.6;">
                                    <div
                                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <h5 style="margin: 0; color: #333;">
                                            <span id="step-3-icon">‚è∏Ô∏è</span> Passo 3: Connetti Smartphone
                                        </h5>
                                        <span id="step-3-status" style="font-size: 0.8em; color: #6c757d;">In
                                            attesa</span>
                                    </div>
                                    <p style="margin: 0.5rem 0; color: #555; font-size: 0.9em;">
                                        Apri l'app IRIUN sul telefono. Assicurati che PC e telefono siano sulla stessa
                                        rete Wi-Fi.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                        <button onclick="markStepComplete(3)" class="btn btn-success"
                                            style="font-size: 0.85em; padding: 0.4rem 0.8rem;">
                                            ‚úÖ Connesso
                                        </button>
                                    </div>
                                    <div id="wifi-warning"
                                        style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 0.85em; color: #856404;">
                                        ‚ö†Ô∏è <strong>Importante:</strong> PC e smartphone devono essere sulla stessa rete
                                        Wi-Fi!
                                    </div>
                                </div>

                                <!-- Passo 4: Test Connessione -->
                                <div class="wizard-step" id="step-4"
                                    style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6c757d; opacity: 0.6;">
                                    <div
                                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <h5 style="margin: 0; color: #333;">
                                            <span id="step-4-icon">‚è∏Ô∏è</span> Passo 4: Seleziona IRIUN in Kimerika
                                        </h5>
                                        <span id="step-4-status" style="font-size: 0.8em; color: #6c757d;">In
                                            attesa</span>
                                    </div>
                                    <p style="margin: 0.5rem 0; color: #555; font-size: 0.9em;">
                                        Clicca il pulsante qui sotto per testare la connessione e avviare la webcam
                                        IRIUN.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                        <button onclick="testIriunWebcam()" class="btn btn-primary"
                                            style="font-size: 0.85em; padding: 0.4rem 0.8rem;">
                                            üé• Avvia Webcam IRIUN
                                        </button>
                                    </div>
                                    <div id="webcam-test-result" style="margin-top: 0.5rem;"></div>
                                </div>

                                <!-- Stato Finale -->
                                <div id="wizard-complete"
                                    style="display: none; padding: 1rem; background: #d4edda; border-left: 4px solid #28a745; border-radius: 8px; margin-bottom: 1rem;">
                                    <h5 style="margin: 0 0 0.5rem 0; color: #155724;">
                                        üéâ Configurazione Completata!
                                    </h5>
                                    <p style="margin: 0; color: #155724; font-size: 0.9em;">
                                        Il tuo smartphone √® ora configurato come webcam. Usa il pulsante "üìπ Avvia
                                        Webcam" nella sezione SORGENTE quando vuoi utilizzarlo.
                                    </p>
                                </div>

                                <!-- Pulsante Reset Wizard -->
                                <button onclick="resetWizard()" class="btn btn-secondary"
                                    style="width: 100%; font-size: 0.85em; padding: 0.5rem; margin-bottom: 1rem;">
                                    üîÑ Resetta Procedura Guidata
                                </button>
                            </div>

                            <details style="margin-top: 1rem;">
                                <summary
                                    style="cursor: pointer; font-weight: bold; padding: 0.5rem; background: #667eea; color: white; border-radius: 4px;">
                                    üìö Guida Completa IRIUN
                                </summary>
                                <div
                                    style="padding: 1rem; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; margin-top: 0.5rem; font-size: 0.85em; line-height: 1.6; color: #333;">
                                    <h5 style="margin-top: 0; color: #667eea;">üíª Passo 1: Installazione PC</h5>
                                    <ol style="margin-left: 1.2rem; color: #444;">
                                        <li>Vai su <a href="https://iriun.com" target="_blank"
                                                style="color: #667eea; font-weight: bold;">iriun.com</a></li>
                                        <li>Scarica e installa <strong>IRIUN Webcam</strong> per Windows/Mac/Linux</li>
                                        <li>Avvia l'applicazione IRIUN sul PC</li>
                                    </ol>

                                    <h5 style="color: #667eea;">üì± Passo 2: Installazione Smartphone</h5>
                                    <ol style="margin-left: 1.2rem; color: #444;">
                                        <li>Sul telefono, apri Google Play Store (Android) o App Store (iOS)</li>
                                        <li>Cerca <strong>"IRIUN Webcam"</strong></li>
                                        <li>Installa l'app sul telefono</li>
                                    </ol>

                                    <h5 style="color: #667eea;">üîó Passo 3: Connessione</h5>
                                    <ol style="margin-left: 1.2rem; color: #444;">
                                        <li><strong>Importante:</strong> Assicurati che PC e smartphone siano sulla
                                            <strong>stessa rete Wi-Fi</strong></li>
                                        <li>Apri l'app IRIUN sul telefono</li>
                                        <li>L'app rilever√† automaticamente il PC sulla rete</li>
                                        <li>Sul PC, vedrai la connessione confermata nell'app IRIUN</li>
                                    </ol>

                                    <h5 style="color: #667eea;">üé• Passo 4: Usa in Kimerika</h5>
                                    <ol style="margin-left: 1.2rem; color: #444;">
                                        <li>Con IRIUN connesso, clicca su <strong>"üìπ Avvia Webcam"</strong> nella
                                            sezione SORGENTE</li>
                                        <li>Il browser chieder√† il permesso di accedere alla webcam</li>
                                        <li>Seleziona <strong>"IRIUN Webcam"</strong> dalla lista dispositivi</li>
                                        <li>Clicca "Consenti" - il video del telefono apparir√† nel canvas!</li>
                                    </ol>

                                    <h5 style="color: #667eea;">üí° Suggerimenti</h5>
                                    <ul style="margin-left: 1.2rem; color: #444;">
                                        <li>‚úîÔ∏è Usa Wi-Fi 5GHz per migliore qualit√†</li>
                                        <li>‚úîÔ∏è Posiziona il telefono su un supporto stabile</li>
                                        <li>‚úîÔ∏è Assicurati che il telefono sia carico o collegato</li>
                                        <li>‚úîÔ∏è Usa buona illuminazione per risultati ottimali</li>
                                        <li>‚úîÔ∏è La risoluzione Full HD √® supportata (1080p)</li>
                                    </ul>

                                    <div
                                        style="background: #d1ecf1; padding: 0.8rem; border-radius: 4px; margin-top: 1rem; border-left: 4px solid #0c5460; color: #0c5460;">
                                        <strong>üéØ Nota:</strong> IRIUN √® gratuito per uso personale.
                                        La versione premium rimuove il watermark e aggiunge funzioni avanzate.
                                    </div>
                                </div>
                            </details>

                            <a href="https://iriun.com" target="_blank" class="btn btn-primary"
                                style="display: block; text-align: center; text-decoration: none; margin-top: 1rem;">
                                üåê Scarica IRIUN Webcam
                            </a>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- CANVAS CENTRALE identico al matplotlib canvas -->
        <div class="canvas-container">
            <!-- Toolbar strumenti -->
            <div class="canvas-toolbar">
                <button class="tool-btn" data-tool="pan" onclick="setTool('pan')" title="Sposta vista canvas">‚úã
                    Pan</button>
                <button class="tool-btn" data-tool="zoom-in" onclick="setTool('zoom-in')"
                    title="Ingrandisci al click">üîç+ Zoom In</button>
                <button class="tool-btn" data-tool="zoom-out" onclick="setTool('zoom-out')"
                    title="Rimpicciolisci al click">üîç- Zoom Out</button>
                <button class="tool-btn" onclick="rotateImageClockwise()" title="Ruota immagine 1¬∞ in senso orario">‚Üª
                    Ruota ‚ü≤</button>
                <button class="tool-btn" onclick="rotateImageCounterClockwise()"
                    title="Ruota immagine 1¬∞ in senso antiorario">‚Ü∫ Ruota ‚ü≥</button>
                <button class="tool-btn" data-tool="line" onclick="setTool('line')" title="Disegna linea">üìè
                    Linea</button>
                <button class="tool-btn" onclick="clearAllMeasurementOverlays()" title="Pulisci tutte le misurazioni">üìê
                    Pulisci Mis.</button>
                <button class="tool-btn" onclick="clearCanvas()" title="Pulisci canvas completamente">üßπ
                    Pulisci</button>
            </div>

            <!-- Canvas principale -->
            <div class="canvas-wrapper">
                <canvas id="main-canvas"></canvas>
            </div>

            <!-- Video webcam nascosto -->
            <video id="webcam-video" autoplay muted style="position: absolute; left: -9999px; top: -9999px;"></video>

            <!-- Info cursore -->
            <div class="cursor-info" id="cursor-info">
                Mouse: (0, 0) | Zoom: 100%
            </div>
        </div>

        <!-- SIDEBAR DESTRA identica alla colonna destra dell'app -->
        <div class="right-sidebar">

            <!-- Anteprima - PRIMA POSIZIONE -->
            <div class="section" data-expanded="false">
                <div class="section-header" onclick="toggleSection(this)">
                    <button class="toggle-btn">üìπ ANTEPRIMA</button>
                    <span class="icon">‚ñ∫</span>
                </div>
                <div class="section-content webcam-preview-content" style="display: none;">
                    <canvas id="webcam-preview-canvas"></canvas>
                    <div id="webcam-preview-info">Anteprima non attiva</div>

                    <!-- Monitor debug websocket -->
                    <div class="status-info-frame">
                        <div class="best-frame-info" id="best-frame-info">
                            Nessun frame analizzato
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sezione Dati Analisi Unificata -->
            <div class="section" data-expanded="false">
                <div class="section-header" onclick="toggleSection(this)">
                    <button class="toggle-btn">üìä DATI ANALISI</button>
                    <span class="icon">‚ñ∫</span>
                </div>
                <div class="section-content" style="display: none;">
                    <!-- Tabs per selezionare il tipo di dati -->
                    <div class="unified-tabs">
                        <button class="unified-tab active" data-tab="measurements"
                            onclick="switchUnifiedTab('measurements', event)">
                            üìè Misurazioni
                        </button>
                        <button class="unified-tab" data-tab="landmarks" onclick="switchUnifiedTab('landmarks', event)">
                            üéØ Landmarks
                        </button>
                        <button class="unified-tab" data-tab="debug" onclick="switchUnifiedTab('debug', event)">
                            üêõ Debug
                        </button>
                    </div>

                    <!-- Tabella Unificata -->
                    <div class="table-container">
                        <table class="data-table" id="unified-table">
                            <thead id="unified-table-head">
                                <!-- Header dinamico basato sul tab selezionato -->
                            </thead>
                            <tbody id="unified-table-body">
                                <!-- Dati dinamici verranno inseriti qui -->
                            </tbody>
                        </table>
                    </div>


                </div>
            </div>

            <!-- Sezioni originali (nascoste, ma mantengono i dati per compatibilit√†) -->
            <div style="display: none;">
                <!-- Sezione Misurazioni Originale (nascosta) -->
                <div class="section" data-expanded="false">
                    <div class="section-content">
                        <div class="table-container">
                            <table class="data-table" id="measurements-table">
                                <thead>
                                    <tr>
                                        <th>üìè Tipo Misurazione</th>
                                        <th>üìä Valore</th>
                                        <th>üìê Unit√†</th>
                                        <th>‚úÖ Stato</th>
                                    </tr>
                                </thead>
                                <tbody id="measurements-data">
                                    <!-- Dati dinamici verranno inseriti qui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Sezione Landmarks Originale (nascosta) -->
                <div class="section" data-expanded="false">
                    <div class="section-content">
                        <div class="table-container">
                            <table class="data-table" id="landmarks-table">
                                <thead>
                                    <tr>
                                        <th>üé®</th>
                                        <th>ID</th>
                                        <th>Nome</th>
                                        <th>X</th>
                                        <th>Y</th>
                                    </tr>
                                </thead>
                                <tbody id="landmarks-data">
                                    <!-- Dati landmarks verranno inseriti qui -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Controlli paginazione landmarks -->
                        <div class="landmarks-controls" id="landmarks-pagination" style="display: none;">
                            <button class="btn btn-mini" onclick="showLandmarksPage('prev')" id="landmarks-prev">‚óÄ
                                Prec</button>
                            <span class="landmarks-page-info" id="landmarks-page-info">Pagina 1/1</span>
                            <button class="btn btn-mini" onclick="showLandmarksPage('next')" id="landmarks-next">Succ
                                ‚ñ∂</button>
                            <button class="btn btn-mini" onclick="showAllLandmarks()"
                                title="Mostra tutti i landmarks in una nuova finestra">üìã Tutti</button>
                        </div>
                    </div>
                </div>

                <!-- Debug Analysis Originale (nascosta) -->
                <div class="section" data-expanded="false">
                    <div class="section-content debug-content">
                        <div class="table-container">
                            <table class="data-table debug-table" id="debug-table">
                                <thead>
                                    <tr>
                                        <th>Frame</th>
                                        <th>Tempo</th>
                                        <th>Score</th>
                                        <th>Yaw</th>
                                        <th>Pitch</th>
                                        <th>Roll</th>
                                        <th>Stato</th>
                                    </tr>
                                </thead>
                                <tbody id="debug-data">
                                    <!-- Dati debug verranno inseriti qui -->
                                </tbody>
                            </table>
                        </div>
                        <div class="debug-controls">
                            <button class="btn btn-small" onclick="clearDebugLogs()">Pulisci</button>
                            <button class="btn btn-small" onclick="ensureSidebarSectionsVisible()"
                                title="Ripristina visibilit√† sezioni">üîß Ripristina UI</button>
                            <label class="auto-scroll-label">
                                <input type="checkbox" id="auto-scroll"> Auto
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>

    <!-- Finestra modale per anteprima video -->
    <div id="preview-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Anteprima Video - Analisi in corso</h3>
                <span class="close" onclick="closeVideoPreview()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Player video per anteprima in tempo reale -->
                <div id="video-player-container" style="display: none;">
                    <video id="preview-video" width="640" height="480" controls>
                        Il tuo browser non supporta il tag video.
                    </video>
                    <div class="video-controls">
                        <button id="analyze-current-frame" class="btn btn-primary">üéØ Analizza Frame Corrente</button>
                        <button id="auto-analyze" class="btn btn-success">ü§ñ Analisi Automatica</button>
                        <button id="stop-analysis" class="btn btn-danger" style="display: none;">‚èπÔ∏è Ferma</button>
                    </div>
                </div>

                <!-- Canvas per risultati analisi -->
                <canvas id="preview-canvas" width="640" height="480" style="display: none;"></canvas>

                <!-- Area info/status -->
                <div class="preview-info" id="preview-info">
                    In attesa del video...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal separato per l'analisi video automatica -->
    <div id="video-analysis-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Analisi Video Automatica</h3>
                <span class="close" onclick="closeVideoAnalysis()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="video-analysis-status">
                    <div class="analysis-progress">
                        <div class="spinner"></div>
                        <p>Analisi in corso...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Analisi Visagistica Completa -->
    <div id="analysis-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <span style="opacity: 0.6; margin-right: 10px; font-size: 20px;">‚ãÆ‚ãÆ</span>
                <h3>üß¨ Analisi Visagistica Completa</h3>
                <span class="close" onclick="closeAnalysisModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Loading spinner -->
                <div id="analysis-loading" style="text-align: center; padding: 40px; display: none;">
                    <div class="spinner"
                        style="width: 60px; height: 60px; border: 5px solid #f3f3f3; border-top: 5px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;">
                    </div>
                    <p style="margin-top: 20px; font-size: 16px; color: #667eea;">Analisi in corso...</p>
                </div>

                <!-- Report completo -->
                <div id="analysis-report" style="display: none;">
                    <div
                        style="margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="generateAnalysisPDF()"
                            style="font-size: 16px; padding: 12px 24px;">
                            üìÑ Genera PDF
                        </button>
                        <button class="btn btn-info" id="read-report-btn" onclick="toggleReportReading()"
                            style="font-size: 16px; padding: 12px 24px;">
                            üîä Leggi Report
                        </button>
                        <button class="btn btn-secondary" onclick="closeAnalysisModal()"
                            style="font-size: 16px; padding: 12px 24px;">
                            ‚úñÔ∏è Chiudi
                        </button>
                    </div>

                    <div id="report-content"
                        style="background: #f9f9f9; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; white-space: pre-wrap; line-height: 1.6; color: #333;">
                        <!-- Il report verr√† inserito qui -->
                    </div>

                    <!-- Immagini debug (opzionale) -->
                    <div id="debug-images-container" style="margin-top: 30px; display: none;">
                        <h4 style="margin-bottom: 15px;">üì∏ Immagini di Analisi</h4>
                        <div id="debug-images-grid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                            <!-- Le immagini verranno inserite qui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status bar -->
    <div class="status-bar">
        <div class="status-text" id="status-text">Pronto</div>
        <div class="progress-container" id="progress-container" style="display: none;">
            <div class="progress-bar" id="progress-bar"></div>
            <span class="progress-text" id="progress-text">0%</span>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Patch per bug textBaseline PRIMA di Fabric.js -->
    <script>
        console.log('üîß Applicando patch preventivo per textBaseline...');

        // Patch preventivo per il CanvasRenderingContext2D
        if (typeof CanvasRenderingContext2D !== 'undefined') {
            const descriptor = Object.getOwnPropertyDescriptor(CanvasRenderingContext2D.prototype, 'textBaseline');
            if (descriptor && descriptor.set) {
                const originalSetter = descriptor.set;
                Object.defineProperty(CanvasRenderingContext2D.prototype, 'textBaseline', {
                    set: function (value) {
                        // Correggi automaticamente il valore errato PRIMA che causi errori
                        if (value === 'alphabetical') {
                            // Correzione silenziosa per evitare spam nella console
                            value = 'alphabetic';
                        }
                        return originalSetter.call(this, value);
                    },
                    get: descriptor.get,
                    enumerable: true,
                    configurable: true
                });
            }
        }

        console.log('üîß Patch preventivo applicato!');
    </script>

    <!-- Fabric.js per canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

    <!-- jsPDF per generazione PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="static/js/api-client.js"></script>
    <script src="static/js/face-detection.js"></script>
    <script src="static/js/measurements.js"></script>
    <script src="static/js/scoring.js"></script>
    <script src="static/js/canvas.js"></script>
    <!-- Sistema modalit√† canvas (PAN, ZOOM, SELEZIONE) -->
    <script src="static/js/canvas-modes.js"></script>
    <!-- NUOVO FILE PULITO - Correzione sopracciglia -->
    <script src="static/js/eyebrow-correction.js"></script>
    <!-- Analisi Visagistica Completa -->
    <script src="static/js/face-analysis-complete.js"></script>
    <script src="static/js/main.js"></script>

    <!-- Script di test per debug -->
    <script>
        console.log('üß™ TEST SCRIPT CARICATO');

        // Test dopo il caricamento completo
        window.addEventListener('load', function () {
            console.log('üß™ PAGINA COMPLETAMENTE CARICATA');
            console.log('üß™ Stato variabili globali:', {
                currentLandmarks: typeof currentLandmarks !== 'undefined' ? currentLandmarks?.length : 'undefined',
                fabricCanvas: typeof fabricCanvas !== 'undefined' ? !!fabricCanvas : 'undefined',
                transformLandmarkCoordinate: typeof window.transformLandmarkCoordinate !== 'undefined' ? 'function available' : 'undefined',
                measureFaceWidth: typeof measureFaceWidth !== 'undefined' ? 'function available' : 'undefined'
            });

            // Test diretto della funzione di misurazione (disabilitato)
            // setTimeout(() => {
            //     console.log('üß™ TEST DIRETTO - Chiamata measureFaceWidth()');
            //     if (typeof measureFaceWidth === 'function') {
            //         try {
            //             measureFaceWidth();
            //         } catch (e) {
            //             console.error('üß™ ERRORE in measureFaceWidth:', e);
            //         }
            //     } else {
            //         console.error('üß™ measureFaceWidth NON DEFINITA');
            //     }
            // }, 2000);
        });
    </script>

    <!-- MediaPipe per face detection -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

    <!-- ========================================
         VOICE ASSISTANT INTEGRATION
         ======================================== -->

    <!-- Voice Assistant Script -->
    <script src="static/js/voice_assistant.js"></script>

    <!-- Voice Widget Container (NASCOSTO - ora √® nella sidebar) -->
    <div id="voice-widget-container" style="display: none;"></div>

    <script>
        // Carica widget voice assistant (nascosto, manteniamo solo per compatibilit√† script)
        fetch('templates/voice_widget.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('voice-widget-container').innerHTML = html;
            })
            .catch(err => console.warn('Voice widget non caricato:', err));
    </script>

    <!-- Integrazione Voice Feedback nelle funzioni esistenti -->
    <script>
        // Attendi che voiceAssistant sia disponibile
        if (typeof voiceAssistant !== 'undefined') {

            // Non sovrascrivere loadImage, loadVideo, startWebcam, stopWebcam
            // perch√© ora il voice assistant simula click sui pulsanti

            // Aggiungi listener per il caricamento immagine/video
            // (il feedback vocale verr√† dato quando il file √® effettivamente caricato)
            const originalHandleFileLoad = window.handleFileLoad;
            if (originalHandleFileLoad) {
                window.handleFileLoad = function (file) {
                    const result = originalHandleFileLoad(file);
                    // Feedback vocale dopo il caricamento
                    setTimeout(() => {
                        voiceAssistant.speakMessage('image_loaded');
                    }, 500);
                    return result;
                };
            }

            // SORGENTE - Avvia Webcam
            const originalStartWebcam = window.startWebcam;
            window.startWebcam = async function () {
                if (originalStartWebcam) await originalStartWebcam();
                voiceAssistant.speakMessage('webcam_started');
            };

            // SORGENTE - Stop Webcam
            const originalStopWebcam = window.stopWebcam;
            window.stopWebcam = function () {
                if (originalStopWebcam) originalStopWebcam();
                voiceAssistant.speakMessage('webcam_stopped');
            };

            // TOGGLE - Asse di Simmetria
            const originalToggleAxis = window.toggleAxis;
            window.toggleAxis = function () {
                if (originalToggleAxis) originalToggleAxis();

                // Non emettere feedback vocale se siamo in modalit√† suppress
                if (window.suppressVoiceFeedback) {
                    console.log('üîá [ASSE] Feedback vocale soppresso (suppressVoiceFeedback attivo)');
                    return;
                }

                const axisBtn = document.getElementById('axis-btn');
                if (axisBtn && axisBtn.classList.contains('active')) {
                    voiceAssistant.speakMessage('axis_on');
                } else {
                    voiceAssistant.speakMessage('axis_off');
                }
            };

            // TOGGLE - Landmarks
            const originalToggleLandmarks = window.toggleLandmarks;
            window.toggleLandmarks = function () {
                if (originalToggleLandmarks) originalToggleLandmarks();

                // Non emettere feedback vocale se siamo in modalit√† suppress
                if (window.suppressVoiceFeedback) {
                    console.log('üîá [LANDMARKS] Feedback vocale soppresso (suppressVoiceFeedback attivo)');
                    return;
                }

                const landmarksBtn = document.getElementById('landmarks-btn');
                if (landmarksBtn && landmarksBtn.classList.contains('active')) {
                    voiceAssistant.speakMessage('landmarks_on');
                } else {
                    voiceAssistant.speakMessage('landmarks_off');
                }
            };

            // TOGGLE - Green Dots
            // Il feedback vocale delle differenze √® ora gestito automaticamente in main.js
            // dopo il completamento dell'analisi green dots
            const originalToggleGreenDots = window.toggleGreenDots;
            window.toggleGreenDots = function () {
                if (originalToggleGreenDots) originalToggleGreenDots();

                // Non emettere feedback vocale se siamo in modalit√† suppress (es: durante analisi progettazione)
                if (window.suppressVoiceFeedback) {
                    console.log('üîá [GREEN DOTS] Feedback vocale soppresso (suppressVoiceFeedback attivo)');
                    return;
                }

                // I messaggi generici on/off non servono pi√π perch√© ora c'√® l'analisi dettagliata
                // gestita da main.js che pronuncia le differenze tra i sopraccigli
            };

            // Funzione per comando vocale "preferenza destra" - analizza spostamenti sopracciglio sinistro
            window.show_left_eyebrow_with_voice = async function () {
                console.log('üéØ [PREFERENZA DESTRA] Inizio analisi preferenza destra');
                console.log('üîç [PREFERENZA DESTRA] Verifica funzioni disponibili:', {
                    showLeftEyebrow: typeof window.showLeftEyebrow,
                    voiceAssistant: typeof voiceAssistant,
                    greenDotsDetected: !!window.greenDotsDetected
                });

                // Verifica prerequisiti
                if (!window.greenDotsDetected || !window.greenDotsData?.success) {
                    console.error('‚ùå [PREFERENZA DESTRA] Green dots non rilevati');
                    if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                        voiceAssistant.speak('Prima devi rilevare i punti verdi con il pulsante green dots');
                    }
                    return;
                }

                // Step 1: Apri il popup della correzione sopracciglio sinistro
                if (typeof window.showLeftEyebrow === 'function') {
                    console.log('üìä [PREFERENZA DESTRA] Apertura popup correzione...');
                    try {
                        window.showLeftEyebrow();
                        console.log('‚úÖ [PREFERENZA DESTRA] Popup aperto con successo');
                    } catch (error) {
                        console.error('‚ùå [PREFERENZA DESTRA] Errore apertura popup:', error);
                        if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                            voiceAssistant.speak('Errore apertura finestra correzione');
                        }
                        return;
                    }

                    // Step 2: Aspetta che il popup sia aperto (breve delay)
                    await new Promise(resolve => setTimeout(resolve, 800));

                    // Step 3: Analizza gli spostamenti dalla tabella
                    console.log('üìè [PREFERENZA DESTRA] Analisi spostamenti dalla tabella...');
                    const instructions = window.analyzeLeftEyebrowMovements();

                    if (instructions) {
                        console.log('üîä [PREFERENZA DESTRA] Pronuncia indicazioni:', instructions);
                        if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                            voiceAssistant.speak(instructions);
                        }
                    } else {
                        console.error('‚ùå [PREFERENZA DESTRA] Impossibile generare indicazioni');
                        if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                            voiceAssistant.speak('Non ho trovato abbastanza dati per generare le indicazioni');
                        }
                    }
                } else {
                    console.error('‚ùå [PREFERENZA DESTRA] Funzione showLeftEyebrow non disponibile');
                    console.error('    window.showLeftEyebrow:', window.showLeftEyebrow);
                    if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                        voiceAssistant.speak('Funzione correzione non disponibile');
                    }
                }
            };

            // Funzione per analizzare gli spostamenti necessari del sopracciglio sinistro
            window.analyzeLeftEyebrowMovements = function () {
                console.log('üìä [MOVIMENTI SX] Analisi movimenti sopracciglio sinistro');

                const measurementsTable = document.getElementById('measurements-data');
                if (!measurementsTable) {
                    console.error('‚ùå [MOVIMENTI SX] Tabella misurazioni non trovata');
                    return null;
                }

                const rows = measurementsTable.querySelectorAll('tr[data-type="green-dots"]');
                if (rows.length === 0) {
                    console.error('‚ùå [MOVIMENTI SX] Nessun dato green dots trovato');
                    return null;
                }

                // Mappa per raccogliere i dati: punto -> {horizontal, vertical}
                const movements = {
                    'LA': { horizontal: 0, vertical: 0 },
                    'LA0': { horizontal: 0, vertical: 0 },
                    'LC1': { horizontal: 0, vertical: 0 },
                    'LB': { horizontal: 0, vertical: 0 },
                    'LC': { horizontal: 0, vertical: 0 }
                };

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 2) return;

                    const label = cells[0].textContent.trim();
                    const value = cells[1].textContent.trim();

                    // Estrai le distanze e determina gli spostamenti
                    // Formato: "LA: 40.2px | RA: 40.9px RA pi√π esterno (+0.7px)"

                    // LA vs RA - Distanza Asse (orizzontale)
                    if (label.includes('LA vs RA') && label.includes('Distanza Asse')) {
                        const laMatch = value.match(/LA:\s*([\d.]+)px/);
                        const raMatch = value.match(/RA:\s*([\d.]+)px/);
                        if (laMatch && raMatch) {
                            const laDist = parseFloat(laMatch[1]);
                            const raDist = parseFloat(raMatch[1]);
                            movements['LA'].horizontal = raDist - laDist; // positivo = spostare pi√π esterno
                        }
                    }

                    // LA vs RA - Altezza (verticale)
                    if (label.includes('LA vs RA') && label.includes('Altezza')) {
                        const diff = value.match(/\(([\d.]+)px\)/);
                        if (diff) {
                            const pixels = parseFloat(diff[1]);
                            // Se RA pi√π alto, LA deve salire (negativo)
                            movements['LA'].vertical = value.includes('RA pi√π alto') ? -pixels : pixels;
                        }
                    }

                    // LA0 vs RA0 - Distanza Asse
                    if (label.includes('LA0 vs RA0') && label.includes('Distanza Asse')) {
                        const la0Match = value.match(/LA0:\s*([\d.]+)px/);
                        const ra0Match = value.match(/RA0:\s*([\d.]+)px/);
                        if (la0Match && ra0Match) {
                            const la0Dist = parseFloat(la0Match[1]);
                            const ra0Dist = parseFloat(ra0Match[1]);
                            movements['LA0'].horizontal = ra0Dist - la0Dist;
                        }
                    }

                    // LC1 vs RC1 - Distanza Asse
                    if (label.includes('LC1 vs RC1') && label.includes('Distanza Asse')) {
                        const lc1Match = value.match(/LC1:\s*([\d.]+)px/);
                        const rc1Match = value.match(/RC1:\s*([\d.]+)px/);
                        if (lc1Match && rc1Match) {
                            const lc1Dist = parseFloat(lc1Match[1]);
                            const rc1Dist = parseFloat(rc1Match[1]);
                            movements['LC1'].horizontal = rc1Dist - lc1Dist;
                        }
                    }

                    // LC1 vs RC1 - Altezza
                    if (label.includes('LC1 vs RC1') && label.includes('Altezza')) {
                        const diff = value.match(/\(([\d.]+)px\)/);
                        if (diff) {
                            const pixels = parseFloat(diff[1]);
                            movements['LC1'].vertical = value.includes('RC1 pi√π alto') ? -pixels : pixels;
                        }
                    }

                    // LB vs RB - Distanza Asse
                    if (label.includes('LB vs RB') && label.includes('Distanza Asse')) {
                        const lbMatch = value.match(/LB:\s*([\d.]+)px/);
                        const rbMatch = value.match(/RB:\s*([\d.]+)px/);
                        if (lbMatch && rbMatch) {
                            const lbDist = parseFloat(lbMatch[1]);
                            const rbDist = parseFloat(rbMatch[1]);
                            movements['LB'].horizontal = rbDist - lbDist;
                        }
                    }

                    // LB vs RB - Altezza
                    if (label.includes('LB vs RB') && label.includes('Altezza')) {
                        const diff = value.match(/\(([\d.]+)px\)/);
                        if (diff) {
                            const pixels = parseFloat(diff[1]);
                            movements['LB'].vertical = value.includes('RB pi√π alto') ? -pixels : pixels;
                        }
                    }

                    // LC vs RC - Distanza Asse
                    if (label.includes('LC vs RC') && label.includes('Distanza Asse')) {
                        const lcMatch = value.match(/LC:\s*([\d.]+)px/);
                        const rcMatch = value.match(/RC:\s*([\d.]+)px/);
                        if (lcMatch && rcMatch) {
                            const lcDist = parseFloat(lcMatch[1]);
                            const rcDist = parseFloat(rcMatch[1]);
                            movements['LC'].horizontal = rcDist - lcDist;
                        }
                    }

                    // LC vs RC - Altezza
                    if (label.includes('LC vs RC') && label.includes('Altezza')) {
                        const diff = value.match(/\(([\d.]+)px\)/);
                        if (diff) {
                            const pixels = parseFloat(diff[1]);
                            movements['LC'].vertical = value.includes('RC pi√π alto') ? -pixels : pixels;
                        }
                    }
                });

                console.log('üìè [MOVIMENTI SX] Movimenti calcolati:', movements);

                // Genera le istruzioni vocali nell'ordine richiesto: LA, LA0, LC1, LB, LC
                const pointsOrder = ['LA', 'LA0', 'LC1', 'LB', 'LC'];
                let instructions = '';
                let instructionCount = 0;

                pointsOrder.forEach((point, index) => {
                    const move = movements[point];
                    const parts = [];

                    // Formatta il nome del punto per pronuncia corretta
                    const pointSpeech = formatPointNameForSpeech(point);

                    // Movimento verticale
                    if (Math.abs(move.vertical) > 0.5) {
                        const intensity = getIntensity(Math.abs(move.vertical));
                        const direction = move.vertical < 0 ? 'pi√π in alto' : 'pi√π in basso';
                        parts.push(`${intensity}${direction}`);
                    }

                    // Movimento orizzontale
                    if (Math.abs(move.horizontal) > 0.5) {
                        const intensity = getIntensity(Math.abs(move.horizontal));
                        const direction = move.horizontal > 0 ? 'pi√π esternamente' : 'pi√π internamente';
                        parts.push(`${intensity}${direction}`);
                    }

                    // Determina il connettore in base alla posizione nell'istruzione
                    const connector = instructionCount === 0 ? 'Sposta' : 'sposta';

                    if (parts.length > 0) {
                        instructions += `${connector} ${pointSpeech} ${parts.join(' e ')}. `;
                        instructionCount++;
                    } else {
                        // Anche se non ci sono movimenti, menziona il punto
                        instructions += `${connector} ${pointSpeech} √® gi√† posizionato correttamente. `;
                        instructionCount++;
                    }
                });

                return instructions.trim() || null;
            };

            // Funzione per comando vocale "preferenza sinistra" - analizza spostamenti sopracciglio destro
            window.show_right_eyebrow_with_voice = async function () {
                console.log('üéØ [PREFERENZA SINISTRA] Inizio analisi preferenza sinistra');
                console.log('üîç [PREFERENZA SINISTRA] Verifica funzioni disponibili:', {
                    showRightEyebrow: typeof window.showRightEyebrow,
                    voiceAssistant: typeof voiceAssistant,
                    greenDotsDetected: !!window.greenDotsDetected
                });

                // Verifica prerequisiti
                if (!window.greenDotsDetected || !window.greenDotsData?.success) {
                    console.error('‚ùå [PREFERENZA SINISTRA] Green dots non rilevati');
                    if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                        voiceAssistant.speak('Prima devi rilevare i punti verdi con il pulsante green dots');
                    }
                    return;
                }

                // Step 1: Apri il popup della correzione sopracciglio destro
                if (typeof window.showRightEyebrow === 'function') {
                    console.log('üìä [PREFERENZA SINISTRA] Apertura popup correzione...');
                    try {
                        window.showRightEyebrow();
                        console.log('‚úÖ [PREFERENZA SINISTRA] Popup aperto con successo');
                    } catch (error) {
                        console.error('‚ùå [PREFERENZA SINISTRA] Errore apertura popup:', error);
                        if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                            voiceAssistant.speak('Errore apertura finestra correzione');
                        }
                        return;
                    }

                    // Step 2: Aspetta che il popup sia aperto (breve delay)
                    await new Promise(resolve => setTimeout(resolve, 800));

                    // Step 3: Analizza gli spostamenti dalla tabella
                    console.log('üìè [PREFERENZA SINISTRA] Analisi spostamenti dalla tabella...');
                    const instructions = window.analyzeRightEyebrowMovements();

                    if (instructions) {
                        console.log('üîä [PREFERENZA SINISTRA] Pronuncia indicazioni:', instructions);
                        if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                            voiceAssistant.speak(instructions);
                        }
                    } else {
                        console.error('‚ùå [PREFERENZA SINISTRA] Impossibile generare indicazioni');
                        if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                            voiceAssistant.speak('Non ho trovato abbastanza dati per generare le indicazioni');
                        }
                    }
                } else {
                    console.error('‚ùå [PREFERENZA SINISTRA] Funzione showRightEyebrow non disponibile');
                    console.error('    window.showRightEyebrow:', window.showRightEyebrow);
                    if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                        voiceAssistant.speak('Funzione correzione non disponibile');
                    }
                }
            };

            // Funzione per analizzare gli spostamenti necessari del sopracciglio destro
            window.analyzeRightEyebrowMovements = function () {
                console.log('üìä [MOVIMENTI DX] Analisi movimenti sopracciglio destro');

                const measurementsTable = document.getElementById('measurements-data');
                if (!measurementsTable) {
                    console.error('‚ùå [MOVIMENTI DX] Tabella misurazioni non trovata');
                    return null;
                }

                const rows = measurementsTable.querySelectorAll('tr[data-type="green-dots"]');
                if (rows.length === 0) {
                    console.error('‚ùå [MOVIMENTI DX] Nessun dato green dots trovato');
                    return null;
                }

                // Mappa per raccogliere i dati: punto -> {horizontal, vertical}
                const movements = {
                    'RA': { horizontal: 0, vertical: 0 },
                    'RA0': { horizontal: 0, vertical: 0 },
                    'RC1': { horizontal: 0, vertical: 0 },
                    'RB': { horizontal: 0, vertical: 0 },
                    'RC': { horizontal: 0, vertical: 0 }
                };

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 2) return;

                    const label = cells[0].textContent.trim();
                    const value = cells[1].textContent.trim();

                    // RA vs LA - Distanza Asse (orizzontale) - inverso rispetto a LA
                    if (label.includes('LA vs RA') && label.includes('Distanza Asse')) {
                        const laMatch = value.match(/LA:\s*([\d.]+)px/);
                        const raMatch = value.match(/RA:\s*([\d.]+)px/);
                        if (laMatch && raMatch) {
                            const laDist = parseFloat(laMatch[1]);
                            const raDist = parseFloat(raMatch[1]);
                            movements['RA'].horizontal = laDist - raDist; // positivo = spostare pi√π esterno
                        }
                    }

                    // RA vs LA - Altezza (verticale)
                    if (label.includes('LA vs RA') && label.includes('Altezza')) {
                        const diff = value.match(/\(([\d.]+)px\)/);
                        if (diff) {
                            const pixels = parseFloat(diff[1]);
                            // Se LA pi√π alto, RA deve salire (negativo)
                            movements['RA'].vertical = value.includes('LA pi√π alto') ? -pixels : pixels;
                        }
                    }

                    // RA0 vs LA0 - Distanza Asse
                    if (label.includes('LA0 vs RA0') && label.includes('Distanza Asse')) {
                        const la0Match = value.match(/LA0:\s*([\d.]+)px/);
                        const ra0Match = value.match(/RA0:\s*([\d.]+)px/);
                        if (la0Match && ra0Match) {
                            const la0Dist = parseFloat(la0Match[1]);
                            const ra0Dist = parseFloat(ra0Match[1]);
                            movements['RA0'].horizontal = la0Dist - ra0Dist;
                        }
                    }

                    // RC1 vs LC1 - Distanza Asse
                    if (label.includes('LC1 vs RC1') && label.includes('Distanza Asse')) {
                        const lc1Match = value.match(/LC1:\s*([\d.]+)px/);
                        const rc1Match = value.match(/RC1:\s*([\d.]+)px/);
                        if (lc1Match && rc1Match) {
                            const lc1Dist = parseFloat(lc1Match[1]);
                            const rc1Dist = parseFloat(rc1Match[1]);
                            movements['RC1'].horizontal = lc1Dist - rc1Dist;
                        }
                    }

                    // RC1 vs LC1 - Altezza
                    if (label.includes('LC1 vs RC1') && label.includes('Altezza')) {
                        const diff = value.match(/\(([\d.]+)px\)/);
                        if (diff) {
                            const pixels = parseFloat(diff[1]);
                            movements['RC1'].vertical = value.includes('LC1 pi√π alto') ? -pixels : pixels;
                        }
                    }

                    // RB vs LB - Distanza Asse
                    if (label.includes('LB vs RB') && label.includes('Distanza Asse')) {
                        const lbMatch = value.match(/LB:\s*([\d.]+)px/);
                        const rbMatch = value.match(/RB:\s*([\d.]+)px/);
                        if (lbMatch && rbMatch) {
                            const lbDist = parseFloat(lbMatch[1]);
                            const rbDist = parseFloat(rbMatch[1]);
                            movements['RB'].horizontal = lbDist - rbDist;
                        }
                    }

                    // RB vs LB - Altezza
                    if (label.includes('LB vs RB') && label.includes('Altezza')) {
                        const diff = value.match(/\(([\d.]+)px\)/);
                        if (diff) {
                            const pixels = parseFloat(diff[1]);
                            movements['RB'].vertical = value.includes('LB pi√π alto') ? -pixels : pixels;
                        }
                    }

                    // RC vs LC - Distanza Asse
                    if (label.includes('LC vs RC') && label.includes('Distanza Asse')) {
                        const lcMatch = value.match(/LC:\s*([\d.]+)px/);
                        const rcMatch = value.match(/RC:\s*([\d.]+)px/);
                        if (lcMatch && rcMatch) {
                            const lcDist = parseFloat(lcMatch[1]);
                            const rcDist = parseFloat(rcMatch[1]);
                            movements['RC'].horizontal = lcDist - rcDist;
                        }
                    }

                    // RC vs LC - Altezza
                    if (label.includes('LC vs RC') && label.includes('Altezza')) {
                        const diff = value.match(/\(([\d.]+)px\)/);
                        if (diff) {
                            const pixels = parseFloat(diff[1]);
                            movements['RC'].vertical = value.includes('LC pi√π alto') ? -pixels : pixels;
                        }
                    }
                });

                console.log('üìè [MOVIMENTI DX] Movimenti calcolati:', movements);

                // Genera le istruzioni vocali nell'ordine richiesto: RA, RA0, RC1, RB, RC
                const pointsOrder = ['RA', 'RA0', 'RC1', 'RB', 'RC'];
                let instructions = '';
                let instructionCount = 0;

                pointsOrder.forEach((point, index) => {
                    const move = movements[point];
                    const parts = [];

                    // Formatta il nome del punto per pronuncia corretta
                    const pointSpeech = formatPointNameForSpeech(point);

                    // Movimento verticale
                    if (Math.abs(move.vertical) > 0.5) {
                        const intensity = getIntensity(Math.abs(move.vertical));
                        const direction = move.vertical < 0 ? 'pi√π in alto' : 'pi√π in basso';
                        parts.push(`${intensity}${direction}`);
                    }

                    // Movimento orizzontale
                    if (Math.abs(move.horizontal) > 0.5) {
                        const intensity = getIntensity(Math.abs(move.horizontal));
                        const direction = move.horizontal > 0 ? 'pi√π esternamente' : 'pi√π internamente';
                        parts.push(`${intensity}${direction}`);
                    }

                    // Determina il connettore in base alla posizione nell'istruzione
                    const connector = instructionCount === 0 ? 'Sposta' : 'sposta';

                    if (parts.length > 0) {
                        instructions += `${connector} ${pointSpeech} ${parts.join(' e ')}. `;
                        instructionCount++;
                    } else {
                        // Anche se non ci sono movimenti, menziona il punto
                        instructions += `${connector} ${pointSpeech} √® gi√† posizionato correttamente. `;
                        instructionCount++;
                    }
                });

                return instructions.trim() || null;
            };

            // Funzione helper per determinare l'intensit√† dello spostamento
            function getIntensity(pixels) {
                if (pixels < 2) return '';
                if (pixels < 5) return 'leggermente ';
                if (pixels < 10) return '';
                if (pixels < 20) return 'molto ';
                return 'molto ';
            }

            // Funzione helper per formattare i nomi dei punti per pronuncia corretta
            function formatPointNameForSpeech(pointName) {
                // Mappa caratteri a pronuncia italiana rallentata
                const letterMap = {
                    'L': 'Elle',      // Pronuncia normale senza accenti
                    'R': 'Erre',
                    'A': 'A',
                    'B': 'Bi',
                    'C': 'Ci',
                    '0': 'Zero',
                    '1': 'Uno'
                };

                // Separa ogni carattere del punto con pause per rallentare
                const letters = pointName.split('').map(char => letterMap[char] || char);

                // Aggiunge piccola pausa prima e dopo, e virgole tra le lettere per rallentare
                return '. ' + letters.join(', ') + ' .';
            }

            // === WIZARD IRIUN - Gestione Procedura Guidata ===
            let wizardState = {
                step1: false,
                step2: false,
                step3: false,
                step4: false
            };

            // Carica stato wizard da localStorage
            function loadWizardState() {
                const saved = localStorage.getItem('iriunWizardState');
                if (saved) {
                    wizardState = JSON.parse(saved);
                    Object.keys(wizardState).forEach(step => {
                        if (wizardState[step]) {
                            const stepNum = parseInt(step.replace('step', ''));
                            updateStepUI(stepNum, 'completed');
                        }
                    });
                    checkWizardCompletion();
                }
            }

            // Salva stato wizard
            function saveWizardState() {
                localStorage.setItem('iriunWizardState', JSON.stringify(wizardState));
            }

            // Marca un passo come completato
            window.markStepComplete = function (stepNum) {
                wizardState['step' + stepNum] = true;
                saveWizardState();
                updateStepUI(stepNum, 'completed');

                // Abilita il prossimo passo
                if (stepNum < 4) {
                    enableStep(stepNum + 1);
                }

                // Mostra warning Wi-Fi al passo 3
                if (stepNum === 2) {
                    document.getElementById('wifi-warning').style.display = 'block';
                }

                checkWizardCompletion();

                // Feedback vocale
                if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                    const messages = [
                        "Passo uno completato. Ora avvia IRIUN sul computer.",
                        "Passo due completato. Ora connetti lo smartphone.",
                        "Passo tre completato. Ora testa la connessione.",
                        "Configurazione completata con successo!"
                    ];
                    voiceAssistant.speak(messages[stepNum - 1]);
                }
            };

            // Aggiorna UI di un passo
            function updateStepUI(stepNum, status) {
                const step = document.getElementById('step-' + stepNum);
                const icon = document.getElementById('step-' + stepNum + '-icon');
                const statusText = document.getElementById('step-' + stepNum + '-status');

                if (status === 'completed') {
                    step.style.borderLeftColor = '#28a745';
                    step.style.opacity = '1';
                    icon.textContent = '‚úÖ';
                    statusText.textContent = 'Completato';
                    statusText.style.color = '#28a745';
                } else if (status === 'active') {
                    step.style.borderLeftColor = '#667eea';
                    step.style.opacity = '1';
                    icon.textContent = '‚ñ∂Ô∏è';
                    statusText.textContent = 'In corso';
                    statusText.style.color = '#667eea';
                } else if (status === 'error') {
                    step.style.borderLeftColor = '#dc3545';
                    step.style.opacity = '1';
                    icon.textContent = '‚ùå';
                    statusText.textContent = 'Errore';
                    statusText.style.color = '#dc3545';
                }
            }

            // Abilita un passo
            function enableStep(stepNum) {
                const step = document.getElementById('step-' + stepNum);
                if (step) {
                    step.style.opacity = '1';
                    updateStepUI(stepNum, 'active');
                }
            }

            // Verifica se IRIUN √® in esecuzione (controlla disponibilit√† webcam)
            window.checkIriunRunning = async function () {
                updateStepUI(2, 'active');

                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    const iriunDevice = videoDevices.find(device =>
                        device.label.toLowerCase().includes('iriun')
                    );

                    if (iriunDevice) {
                        alert('‚úÖ IRIUN Webcam rilevata!\n\nDispositivo: ' + iriunDevice.label + '\n\nPuoi procedere al passo successivo.');
                        markStepComplete(2);
                    } else {
                        alert('‚ö†Ô∏è IRIUN Webcam non rilevata.\n\nAssicurati di:\n1. Aver installato IRIUN sul PC\n2. Aver avviato l\'applicazione IRIUN\n3. Concedere i permessi alla webcam se richiesto\n\nWebcam disponibili:\n' +
                            videoDevices.map((d, i) => (i + 1) + '. ' + (d.label || 'Webcam senza nome')).join('\n'));
                        updateStepUI(2, 'error');
                    }
                } catch (error) {
                    alert('‚ùå Errore durante la verifica:\n\n' + error.message + '\n\nAssicurati di aver concesso i permessi per accedere alla webcam.');
                    updateStepUI(2, 'error');
                }
            };

            // Test completo della webcam IRIUN
            window.testIriunWebcam = async function () {
                const resultDiv = document.getElementById('webcam-test-result');
                resultDiv.innerHTML = '<div style="padding: 0.5rem; background: #cce5ff; border-left: 3px solid #004085; border-radius: 4px; font-size: 0.85em; color: #004085;">‚è≥ Test in corso...</div>';

                try {
                    // Enumera dispositivi
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    const iriunDevice = videoDevices.find(device =>
                        device.label.toLowerCase().includes('iriun')
                    );

                    if (!iriunDevice) {
                        resultDiv.innerHTML = `
                            <div style="padding: 0.5rem; background: #f8d7da; border-left: 3px solid #721c24; border-radius: 4px; font-size: 0.85em; color: #721c24;">
                                ‚ùå <strong>IRIUN non trovata</strong><br>
                                <span style="font-size: 0.9em;">Verifica che IRIUN sia in esecuzione su PC e smartphone.</span><br>
                                <strong style="margin-top: 0.3rem; display: block;">Webcam disponibili:</strong>
                                ${videoDevices.length > 0 ? videoDevices.map((d, i) => `${i + 1}. ${d.label || 'Webcam senza nome'}`).join('<br>') : 'Nessuna webcam trovata'}
                            </div>
                        `;
                        updateStepUI(4, 'error');
                        return;
                    }

                    // Prova ad avviare lo stream
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { deviceId: iriunDevice.deviceId }
                    });

                    // Stream ottenuto con successo
                    const videoTrack = stream.getVideoTracks()[0];
                    const settings = videoTrack.getSettings();

                    resultDiv.innerHTML = `
                        <div style="padding: 0.5rem; background: #d4edda; border-left: 3px solid #155724; border-radius: 4px; font-size: 0.85em; color: #155724;">
                            ‚úÖ <strong>Test Superato!</strong><br>
                            <span style="font-size: 0.9em;">
                                Dispositivo: ${iriunDevice.label}<br>
                                Risoluzione: ${settings.width}x${settings.height}<br>
                                Frame rate: ${settings.frameRate} fps
                            </span>
                        </div>
                    `;

                    // Ferma lo stream dopo il test
                    stream.getTracks().forEach(track => track.stop());

                    // Marca come completato
                    markStepComplete(4);
                    updateStepUI(4, 'completed');

                    // Feedback vocale
                    if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                        voiceAssistant.speak('Test completato con successo! La webcam IRIUN √® pronta per essere utilizzata.');
                    }

                } catch (error) {
                    resultDiv.innerHTML = `
                        <div style="padding: 0.5rem; background: #f8d7da; border-left: 3px solid #721c24; border-radius: 4px; font-size: 0.85em; color: #721c24;">
                            ‚ùå <strong>Errore durante il test:</strong><br>
                            <span style="font-size: 0.9em;">${error.message}</span><br>
                            <span style="font-size: 0.85em; margin-top: 0.3rem; display: block;">
                                Assicurati di aver concesso i permessi per la webcam.
                            </span>
                        </div>
                    `;
                    updateStepUI(4, 'error');
                }
            };

            // Verifica se il wizard √® completo
            function checkWizardCompletion() {
                if (wizardState.step1 && wizardState.step2 && wizardState.step3 && wizardState.step4) {
                    document.getElementById('wizard-complete').style.display = 'block';
                    // Mostra pannello avvio rapido per utenti che hanno completato la configurazione
                    document.getElementById('quick-launch-panel').style.display = 'block';
                }
            }

            // Resetta wizard
            window.resetWizard = function () {
                if (confirm('Vuoi resettare la procedura guidata IRIUN?')) {
                    wizardState = {
                        step1: false,
                        step2: false,
                        step3: false,
                        step4: false
                    };
                    saveWizardState();
                    location.reload();
                }
            };

            // Salta al passo 2 per utenti con IRIUN gi√† installato
            window.skipToStep2 = function () {
                markStepComplete(1);
                if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                    voiceAssistant.speak('Ottimo! Ora verifica che IRIUN sia in esecuzione sul tuo computer.');
                }
            };

            // Auto-rileva IRIUN all'avvio e suggerisci di saltare i passi
            async function autoDetectIriun() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const iriunDevice = devices.find(device =>
                        device.kind === 'videoinput' && device.label.toLowerCase().includes('iriun')
                    );

                    if (iriunDevice) {
                        // IRIUN gi√† rilevata - proponi di saltare direttamente al test
                        const step1 = document.getElementById('step-1');
                        const autoDetectBanner = document.createElement('div');
                        autoDetectBanner.style.cssText = 'margin-top: 0.5rem; padding: 0.5rem; background: #d1ecf1; border-left: 3px solid #0c5460; border-radius: 4px; font-size: 0.85em; color: #0c5460;';
                        autoDetectBanner.innerHTML = `
                            ‚ú® <strong>IRIUN rilevata!</strong> Sembra che tu abbia gi√† configurato IRIUN.<br>
                            <button onclick="quickStart()" class="btn btn-success" style="font-size: 0.85em; padding: 0.3rem 0.6rem; margin-top: 0.3rem;">
                                üöÄ Salta al Test Finale
                            </button>
                        `;
                        step1.appendChild(autoDetectBanner);

                        if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                            voiceAssistant.speak('IRIUN gi√† rilevata. Puoi saltare direttamente al test finale.');
                        }

                        // Mostra pannello avvio rapido per utenti esperti
                        document.getElementById('quick-launch-panel').style.display = 'block';
                    }
                } catch (error) {
                    // Permessi non concessi o errore - ignora silenziosamente
                    console.log('Auto-detect IRIUN non disponibile:', error.message);
                }
            }

            // === SISTEMA AVVIO RAPIDO IRIUN ===
            let quickStartMonitoring = false;
            let quickStartInterval = null;

            // Salva percorso IRIUN per avvii futuri
            window.saveIriunPath = function() {
                const path = document.getElementById('iriun-path-input').value.trim();
                if (path) {
                    localStorage.setItem('iriunExecutablePath', path);
                    alert('‚úÖ Percorso IRIUN salvato!\n\n' + path + '\n\nIl sistema ricorder√† questo percorso per i prossimi avvii rapidi.');
                    
                    if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                        voiceAssistant.speak('Percorso IRIUN salvato con successo.');
                    }
                } else {
                    alert('‚ö†Ô∏è Inserisci un percorso valido.');
                }
            };

            // Apri IRIUN (tenta vari metodi)
            window.openIriunApp = function() {
                const savedPath = localStorage.getItem('iriunExecutablePath');
                
                // Mostra istruzioni per avviare IRIUN
                const instructions = `
üì± Avvia IRIUN Webcam sul tuo PC:

${savedPath ? '‚úÖ Percorso salvato: ' + savedPath : ''}

üîπ METODO 1: Cerca "IRIUN" nel menu Start di Windows
üîπ METODO 2: Vai alla cartella Program Files\\Iriun
üîπ METODO 3: Doppio click su iriun-webcam.exe

Dopo aver avviato IRIUN sul PC:
1. Apri l'app IRIUN sul tuo smartphone
2. Assicurati che PC e telefono siano sulla stessa rete Wi-Fi
3. Clicca "üîç Verifica IRIUN" per controllare la connessione

üí° Suggerimento: Salva il percorso dell'eseguibile nella sezione "‚öôÔ∏è Configura percorso IRIUN" per i prossimi avvii rapidi.
                `.trim();
                
                alert(instructions);
                
                if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                    voiceAssistant.speak('Segui le istruzioni per avviare IRIUN sul tuo computer. Poi apri l\'app sullo smartphone.');
                }
                
                // Avvia monitoraggio automatico
                startIriunMonitoring();
            };

            // Sistema di monitoraggio automatico IRIUN
            function startIriunMonitoring() {
                if (quickStartMonitoring) return; // Gi√† in monitoraggio
                
                quickStartMonitoring = true;
                const statusDiv = document.getElementById('quick-launch-status');
                
                if (statusDiv) {
                    statusDiv.innerHTML = 'üîÑ Monitoraggio attivo... Cercando IRIUN...';
                }
                
                let checkCount = 0;
                const maxChecks = 60; // 60 tentativi = 2 minuti
                
                quickStartInterval = setInterval(async () => {
                    checkCount++;
                    
                    try {
                        const devices = await navigator.mediaDevices.enumerateDevices();
                        const iriunDevice = devices.find(device =>
                            device.kind === 'videoinput' && device.label.toLowerCase().includes('iriun')
                        );
                        
                        if (iriunDevice) {
                            // IRIUN TROVATA!
                            clearInterval(quickStartInterval);
                            quickStartMonitoring = false;
                            
                            if (statusDiv) {
                                statusDiv.innerHTML = '‚úÖ IRIUN connessa! Dispositivo: ' + iriunDevice.label;
                            }
                            
                            // Notifica utente
                            showToast('üéâ IRIUN Smartphone connesso!', 'success');
                            
                            if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                                voiceAssistant.speak('Ottimo! Il tuo smartphone √® ora connesso come webcam IRIUN. Clicco su Avvia Webcam per iniziare.');
                            }
                            
                            // Proponi di avviare la webcam
                            if (confirm('üéâ IRIUN Smartphone connesso!\n\n' + iriunDevice.label + '\n\nVuoi avviare subito la webcam?')) {
                                // Chiudi sezione impostazioni e avvia webcam
                                const settingsSection = document.getElementById('settings-section');
                                if (settingsSection && settingsSection.dataset.expanded === 'true') {
                                    settingsSection.querySelector('.toggle-btn').click();
                                }
                                
                                // Aspetta che la sezione si chiuda e avvia webcam
                                setTimeout(() => {
                                    if (typeof startWebcam === 'function') {
                                        startWebcam();
                                    } else {
                                        document.getElementById('start-webcam-btn').click();
                                    }
                                }, 500);
                            }
                            
                            return;
                        }
                        
                        // Aggiorna stato
                        if (statusDiv) {
                            const dots = '.'.repeat((checkCount % 3) + 1);
                            statusDiv.innerHTML = `üîÑ Cercando IRIUN${dots} (tentativo ${checkCount}/${maxChecks})`;
                        }
                        
                        // Timeout dopo maxChecks
                        if (checkCount >= maxChecks) {
                            clearInterval(quickStartInterval);
                            quickStartMonitoring = false;
                            
                            if (statusDiv) {
                                statusDiv.innerHTML = '‚è±Ô∏è Timeout - IRIUN non rilevata. Riprova.';
                            }
                            
                            if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                                voiceAssistant.speak('IRIUN non rilevata. Verifica che sia in esecuzione su PC e smartphone.');
                            }
                        }
                        
                    } catch (error) {
                        console.error('Errore monitoraggio IRIUN:', error);
                    }
                }, 2000); // Controlla ogni 2 secondi
            }

            // Avvia Quick Start completo
            window.launchQuickStart = function() {
                const statusDiv = document.getElementById('quick-launch-status');
                
                if (quickStartMonitoring) {
                    alert('‚ö†Ô∏è Monitoraggio gi√† attivo!');
                    return;
                }
                
                // Istruzioni per l'utente
                const instructions = `
‚ö° AVVIO RAPIDO IRIUN

Il sistema inizier√† a monitorare automaticamente la connessione IRIUN.

üìã COSA FARE ORA:

1. üíª Avvia l'applicazione IRIUN sul PC
2. üì± Apri l'app IRIUN sullo smartphone  
3. üì∂ Verifica che PC e telefono siano sulla stessa rete Wi-Fi
4. ‚è≥ Attendi il rilevamento automatico (max 2 minuti)

Il sistema ti avviser√† appena rileva la connessione IRIUN!

Vuoi procedere con il monitoraggio automatico?
                `.trim();
                
                if (confirm(instructions)) {
                    if (statusDiv) {
                        statusDiv.innerHTML = 'üöÄ Avvio monitoraggio automatico...';
                    }
                    
                    if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                        voiceAssistant.speak('Avvio monitoraggio automatico IRIUN. Avvia IRIUN sul computer e sullo smartphone.');
                    }
                    
                    // Avvia il monitoraggio
                    setTimeout(() => startIriunMonitoring(), 1000);
                }
            };

            // Avvio rapido per utenti con IRIUN gi√† configurato
            window.quickStart = function () {
                wizardState.step1 = true;
                wizardState.step2 = true;
                wizardState.step3 = true;
                saveWizardState();

                updateStepUI(1, 'completed');
                updateStepUI(2, 'completed');
                updateStepUI(3, 'completed');
                enableStep(4);

                // Scroll al passo 4
                document.getElementById('step-4').scrollIntoView({ behavior: 'smooth', block: 'center' });

                if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                    voiceAssistant.speak('Avvio rapido attivato. Procedi con il test finale della webcam.');
                }
            };

            // Inizializza wizard al caricamento pagina
            document.addEventListener('DOMContentLoaded', function () {
                loadWizardState();
                // Abilita sempre il primo passo
                if (!wizardState.step1) {
                    enableStep(1);
                }

                // Auto-rileva IRIUN dopo 1 secondo (per dare tempo al browser)
                setTimeout(autoDetectIriun, 1000);
            });

            // Funzione per analizzare la progettazione sopraccigliare
            window.analyze_eyebrow_design = async function () {
                console.log('üîç [ANALISI PROGETTAZIONE] Inizio analisi progettazione sopraccigliare');

                // Flag per disabilitare feedback vocali automatici durante questa operazione
                window.suppressVoiceFeedback = true;

                // Step 0: Verifica se ci sono gi√† dati disponibili nella tabella
                const measurementsTable = document.getElementById('measurements-data');
                let existingGreenDotsRows = measurementsTable ? measurementsTable.querySelectorAll('tr[data-type="green-dots"]') : [];

                console.log('üìä [ANALISI PROGETTAZIONE] Righe green dots esistenti:', existingGreenDotsRows.length);

                // Step 1: Se non ci sono dati o il pulsante non √® attivo, esegui analisi green dots
                const greenDotsBtn = document.getElementById('green-dots-btn');
                const needsAnalysis = existingGreenDotsRows.length === 0 ||
                    !greenDotsBtn ||
                    !greenDotsBtn.classList.contains('active');

                if (needsAnalysis) {
                    console.log('üü¢ [ANALISI PROGETTAZIONE] Esecuzione analisi green dots necessaria...');

                    // Attiva il pulsante se non lo √® gi√†
                    if (greenDotsBtn && !greenDotsBtn.classList.contains('active')) {
                        greenDotsBtn.classList.add('active');
                        console.log('‚úÖ [ANALISI PROGETTAZIONE] Pulsante green dots attivato');
                    }

                    // Chiama direttamente detectGreenDots() invece di toggleGreenDots()
                    if (typeof detectGreenDots === 'function') {
                        console.log('üîÑ [ANALISI PROGETTAZIONE] Chiamata detectGreenDots()...');
                        await detectGreenDots();
                    } else {
                        console.error('‚ùå [ANALISI PROGETTAZIONE] detectGreenDots non disponibile');
                        window.suppressVoiceFeedback = false;
                        if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                            voiceAssistant.speak('Errore: funzione green dots non disponibile');
                        }
                        return;
                    }

                    // Step 2: Aspetta che i risultati siano disponibili (max 5 secondi)
                    console.log('‚è≥ [ANALISI PROGETTAZIONE] Attesa risultati green dots...');
                    let attempts = 0;
                    const maxAttempts = 50; // 5 secondi con check ogni 100ms

                    const waitForResults = () => {
                        return new Promise((resolve) => {
                            const checkResults = () => {
                                const table = document.getElementById('measurements-data');
                                const rows = table ? table.querySelectorAll('tr[data-type="green-dots"]') : [];

                                console.log(`üîÑ [ANALISI PROGETTAZIONE] Check ${attempts + 1}/${maxAttempts}: trovate ${rows.length} righe green dots`);

                                if (rows.length > 0 || attempts >= maxAttempts) {
                                    resolve(rows.length > 0);
                                } else {
                                    attempts++;
                                    setTimeout(checkResults, 100);
                                }
                            };
                            checkResults();
                        });
                    };

                    const resultsAvailable = await waitForResults();

                    // Riabilita feedback vocali
                    window.suppressVoiceFeedback = false;

                    if (!resultsAvailable) {
                        console.error('‚ùå [ANALISI PROGETTAZIONE] Timeout: risultati green dots non disponibili');
                        if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                            voiceAssistant.speak('Non sono riuscita a ottenere i risultati dell\'analisi');
                        }
                        return;
                    }
                } else {
                    console.log('‚úÖ [ANALISI PROGETTAZIONE] Dati gi√† disponibili, uso quelli esistenti');
                    // Riabilita feedback vocali subito
                    window.suppressVoiceFeedback = false;
                }

                // Step 3: Analizza i dati dalla tabella
                console.log('üìä [ANALISI PROGETTAZIONE] Analisi dati dalla tabella...');
                const feedback = analyzeEyebrowDesignFromTable();

                if (feedback) {
                    console.log('‚úÖ [ANALISI PROGETTAZIONE] Feedback generato:', feedback);
                    // Step 4: L'assistente pronuncia il feedback usando speak() per testo personalizzato
                    if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                        console.log('üîä [ANALISI PROGETTAZIONE] Invio feedback a voice assistant');
                        voiceAssistant.speak(feedback);
                    } else {
                        console.error('‚ùå [ANALISI PROGETTAZIONE] voiceAssistant.speak non disponibile');
                    }
                } else {
                    console.error('‚ùå [ANALISI PROGETTAZIONE] Impossibile generare feedback');
                    if (typeof voiceAssistant !== 'undefined' && voiceAssistant.speak) {
                        voiceAssistant.speak('Non ho trovato abbastanza dati per l\'analisi');
                    }
                }
            };

            // Funzione per analizzare i dati dalla tabella misurazioni
            window.analyzeEyebrowDesignFromTable = function () {
                console.log('üìä Analisi dati tabella misurazioni');

                const measurementsTable = document.getElementById('measurements-data');
                if (!measurementsTable) {
                    console.error('‚ùå Tabella misurazioni non trovata');
                    return null;
                }

                const rows = measurementsTable.querySelectorAll('tr[data-type="green-dots"]');
                if (rows.length === 0) {
                    console.error('‚ùå Nessun dato green dots trovato');
                    return null;
                }

                console.log(`üìã Trovate ${rows.length} righe di dati green dots`);

                // Estrai i dati rilevanti
                let externalEyebrow = null; // Quale sopracciglio inizia pi√π esternamente (punto A pi√π lontano dall'asse)
                let higherEyebrow = null; // Quale sopracciglio √® pi√π alto (punto C1)
                let longerTail = null; // Quale ha la coda pi√π lunga (punto B)
                let thickerEyebrow = null; // Quale √® pi√π spesso (area)

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 2) return;

                    const label = cells[0].textContent.trim();
                    const value = cells[1].textContent.trim();

                    console.log(`   üìù ${label}: ${value}`);

                    // Analisi punto A (distanza dall'asse) - Il punto PI√ô LONTANO inizia pi√π esternamente
                    if (label.includes('LA vs RA') && label.includes('Distanza Asse')) {
                        // Cerca "LA pi√π esterno" o "RA pi√π esterno" nel nuovo formato
                        if (value.includes('LA pi√π esterno')) {
                            externalEyebrow = 'sinistro'; // LA pi√π lontano = sopracciglio sinistro inizia pi√π esternamente
                        } else if (value.includes('RA pi√π esterno')) {
                            externalEyebrow = 'destro'; // RA pi√π lontano = sopracciglio destro inizia pi√π esternamente
                        }
                    }

                    // Analisi punto C1 (altezza)
                    if (label.includes('LC1 vs RC1') && label.includes('Altezza')) {
                        if (value.includes('LC1')) {
                            higherEyebrow = 'sinistro';
                        } else if (value.includes('RC1')) {
                            higherEyebrow = 'destro';
                        }
                    }

                    // Analisi punto B (coda pi√π lunga) - Il punto PI√ô LONTANO dall'asse ha la coda pi√π lunga
                    if (label.includes('LB vs RB') && label.includes('Distanza Asse')) {
                        // Cerca "LB pi√π esterno" o "RB pi√π esterno" nel nuovo formato
                        if (value.includes('LB pi√π esterno')) {
                            longerTail = 'sinistro'; // LB pi√π lontano = coda sinistra pi√π lunga
                        } else if (value.includes('RB pi√π esterno')) {
                            longerTail = 'destro'; // RB pi√π lontano = coda destra pi√π lunga
                        }
                    }

                    // Analisi area (spessore)
                    if ((label.includes('Poligono Sinistro') || label.includes('Poligono Destro')) && value.includes('MAGGIORE')) {
                        if (label.includes('Sinistro')) {
                            thickerEyebrow = 'sinistro';
                        } else if (label.includes('Destro')) {
                            thickerEyebrow = 'destro';
                        }
                    }
                });

                console.log('üîç Risultati analisi:', {
                    externalEyebrow,
                    higherEyebrow,
                    longerTail,
                    thickerEyebrow
                });

                // Genera il feedback testuale
                if (!externalEyebrow || !higherEyebrow || !longerTail || !thickerEyebrow) {
                    console.warn('‚ö†Ô∏è Alcuni dati mancanti per generare feedback completo');
                }

                // Costruisci la frase seguendo esattamente il formato richiesto
                let feedback = '';

                // 1. Quale sopracciglio inizia pi√π esternamente (punto A pi√π lontano dall'asse)
                if (externalEyebrow === 'destro') {
                    feedback += 'Il sopracciglio alla tua destra inizia pi√π esternamente. ';
                } else if (externalEyebrow === 'sinistro') {
                    feedback += 'Il sopracciglio alla tua sinistra inizia pi√π esternamente. ';
                }

                // 2. Quale sopracciglio √® pi√π alto (C1)
                if (higherEyebrow === 'sinistro') {
                    feedback += 'Il sopracciglio alla tua sinistra √® pi√π alto rispetto l\'altro. ';
                } else if (higherEyebrow === 'destro') {
                    feedback += 'Il sopracciglio alla tua destra √® pi√π alto rispetto l\'altro. ';
                }

                // 3. Quale ha la coda pi√π lunga (B)
                if (longerTail === 'sinistro') {
                    feedback += 'La coda del sopracciglio alla tua sinistra √® pi√π lunga. ';
                } else if (longerTail === 'destro') {
                    feedback += 'La coda del sopracciglio alla tua destra √® pi√π lunga. ';
                }

                // 4. Quale √® pi√π spesso (area)
                if (thickerEyebrow === 'sinistro') {
                    feedback += 'Ed infine il sopracciglio sinistro √® pi√π spesso.';
                } else if (thickerEyebrow === 'destro') {
                    feedback += 'Ed infine il sopracciglio destro √® pi√π spesso.';
                }

                return feedback || null;
            };

            // ANALISI - Volto
            const originalAnalyzeFace = window.analyzeFace;
            window.analyzeFace = async function () {
                voiceAssistant.speakMessage('analysis_start');

                if (originalAnalyzeFace) {
                    try {
                        await originalAnalyzeFace();
                        voiceAssistant.speakMessage('analysis_complete');
                    } catch (error) {
                        voiceAssistant.speakMessage('analysis_failed');
                    }
                }
            };

            // CANVAS - Pulisci
            const originalClearCanvas = window.clearCanvas;
            window.clearCanvas = function () {
                if (originalClearCanvas) originalClearCanvas();
                voiceAssistant.speak('Canvas pulito');
            };

            // MISURAZIONI - Feedback vocale gestito direttamente in measurements.js
            console.log('‚úÖ Voice Assistant integrato con successo');
        }
    </script>

    <!-- Voice Widget Control Functions (Global) -->
    <script>
        // Variabili globali per il widget
        let isVoiceWidgetMinimized = false;
        let isVoiceListening = false;
        let isVoiceMuted = false;

        function toggleVoiceWidget() {
            isVoiceWidgetMinimized = !isVoiceWidgetMinimized;
            const widget = document.getElementById('voice-assistant-widget');
            const btn = document.querySelector('.voice-minimize-btn');

            if (widget && btn) {
                if (isVoiceWidgetMinimized) {
                    widget.classList.add('minimized');
                    btn.textContent = '+';
                } else {
                    widget.classList.remove('minimized');
                    btn.textContent = '‚àí';
                }
            }
        }

        function toggleVoiceListening() {
            if (typeof voiceAssistant === 'undefined') {
                console.error('voiceAssistant non disponibile');
                return;
            }

            // Supporta sia il widget originale che la sidebar
            const btn = document.getElementById('toggle-listening-btn-sidebar') || document.getElementById('toggle-listening-btn');
            const indicator = document.getElementById('status-indicator-sidebar') || document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text-sidebar') || document.getElementById('status-text');
            const icon = document.getElementById('listening-icon-sidebar');
            const text = document.getElementById('listening-text-sidebar');

            isVoiceListening = voiceAssistant.toggleListening();

            if (btn) {
                if (isVoiceListening) {
                    btn.classList.add('active');
                    if (icon) icon.textContent = 'üî¥';
                    if (text) text.textContent = 'Stop Ascolto';
                    if (btn.querySelector('.btn-text')) btn.querySelector('.btn-text').textContent = 'Stop Ascolto';
                    if (btn.querySelector('.btn-icon')) btn.querySelector('.btn-icon').textContent = 'üî¥';
                    if (indicator) {
                        indicator.textContent = 'üî¥';
                        indicator.classList.add('listening');
                    }
                    if (statusText) statusText.textContent = 'In ascolto...';
                } else {
                    btn.classList.remove('active');
                    if (icon) icon.textContent = 'üé§';
                    if (text) text.textContent = 'Avvia Ascolto';
                    if (btn.querySelector('.btn-text')) btn.querySelector('.btn-text').textContent = 'Avvia Ascolto';
                    if (btn.querySelector('.btn-icon')) btn.querySelector('.btn-icon').textContent = 'üé§';
                    if (indicator) {
                        indicator.textContent = 'üü¢';
                        indicator.classList.remove('listening');
                        indicator.classList.add('active');
                    }
                    if (statusText) statusText.textContent = 'Pronto';
                }
            }
        }

        function toggleVoiceMute() {
            if (typeof voiceAssistant === 'undefined') {
                console.error('voiceAssistant non disponibile');
                return;
            }

            // Supporta sia il widget originale che la sidebar
            const btn = document.getElementById('toggle-mute-btn-sidebar') || document.getElementById('toggle-mute-btn');
            const icon = document.getElementById('mute-icon-sidebar');
            const text = document.getElementById('mute-text-sidebar');

            isVoiceMuted = voiceAssistant.toggleMute();

            if (btn) {
                if (isVoiceMuted) {
                    btn.classList.add('active');
                    if (icon) icon.textContent = 'üîá';
                    if (text) text.textContent = 'Unmute';
                    if (btn.querySelector('.btn-text')) btn.querySelector('.btn-text').textContent = 'Unmute';
                    if (btn.querySelector('.btn-icon')) btn.querySelector('.btn-icon').textContent = 'üîá';
                } else {
                    btn.classList.remove('active');
                    if (icon) icon.textContent = 'üîä';
                    if (text) text.textContent = 'Muto';
                    if (btn.querySelector('.btn-text')) btn.querySelector('.btn-text').textContent = 'Muto';
                    if (btn.querySelector('.btn-icon')) btn.querySelector('.btn-icon').textContent = 'üîä';
                }
            }
        }

        // Inizializza voice assistant nella sidebar
        window.addEventListener('load', async () => {
            // Aspetta che voiceAssistant sia disponibile
            let attempts = 0;
            const maxAttempts = 50;

            const waitForVoiceAssistant = () => {
                if (typeof voiceAssistant !== 'undefined') {
                    initVoiceSidebar();
                } else if (attempts < maxAttempts) {
                    attempts++;
                    setTimeout(waitForVoiceAssistant, 100);
                } else {
                    console.error('Voice Assistant non disponibile');
                    const indicator = document.getElementById('status-indicator-sidebar');
                    const statusText = document.getElementById('status-text-sidebar');
                    if (indicator) indicator.textContent = 'üî¥';
                    if (statusText) statusText.textContent = 'Non disponibile';
                }
            };

            waitForVoiceAssistant();
        });

        async function initVoiceSidebar() {
            const indicator = document.getElementById('status-indicator-sidebar');
            const statusText = document.getElementById('status-text-sidebar');

            try {
                const status = await voiceAssistant.getStatus();

                if (status && status.available) {
                    indicator.textContent = 'üü¢';
                    indicator.classList.add('active');
                    statusText.textContent = 'Connesso';
                } else {
                    indicator.textContent = 'üü¢';
                    indicator.classList.add('active');
                    statusText.textContent = 'Pronto';
                }
            } catch (error) {
                console.log('Voice status check fallito, ma TTS potrebbe funzionare');
                indicator.textContent = 'üü¢';
                indicator.classList.add('active');
                statusText.textContent = 'Pronto';
            }
        }
    </script>

</body>

</html>